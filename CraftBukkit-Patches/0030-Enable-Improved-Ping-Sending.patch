From a87ea76cdfdaefe17fd09b8639cbc35d13e97293 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 24 Feb 2013 20:45:20 +1100
Subject: [PATCH] Enable Improved Ping Sending


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 2e234f1..d054efe 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -54,6 +54,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     public int newTotalExp = 0;
     public boolean keepLevel = false;
     public double maxHealthCache;
+    public int lastPing = -1; // Spigot
     // CraftBukkit end
 
     public EntityPlayer(MinecraftServer minecraftserver, World world, String s, PlayerInteractManager playerinteractmanager) {
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index a85fc5b..20b9c5d 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -720,6 +720,25 @@ public abstract class PlayerList {
             this.sendAll(new Packet201PlayerInfo(entityplayer.getName(), true, entityplayer.ping));
         }
         // CraftBukkit end */
+        // Spigot start
+        if ( !players.isEmpty() )
+        {
+            int index = MinecraftServer.currentTick % this.players.size();
+            EntityPlayer player = (EntityPlayer) this.players.get( index );
+            if ( player.lastPing == -1 || Math.abs( player.ping - player.lastPing ) > 20 )
+            {
+                Packet packet = new Packet201PlayerInfo( player.listName, true, player.ping );
+                for ( EntityPlayer splayer : (List<EntityPlayer>) this.players )
+                {
+                    if ( splayer.getBukkitEntity().canSee( player.getBukkitEntity() ) )
+                    {
+                        splayer.playerConnection.sendPacket( packet );
+                    }
+                }
+                player.lastPing = player.ping;
+            }
+        }
+        // Spigot end
     }
 
     public void sendAll(Packet packet) {
-- 
1.8.1.2


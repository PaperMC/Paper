From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/commands/arguments/EntityArgument.java b/net/minecraft/commands/arguments/EntityArgument.java
index f17b77b4e578143f13b0c1aacf5810148180cb87..6fd00b09c1be79e8aec40e87493321c4e24a53c3 100644
--- a/net/minecraft/commands/arguments/EntityArgument.java
+++ b/net/minecraft/commands/arguments/EntityArgument.java
@@ -106,9 +106,14 @@ public class EntityArgument implements ArgumentType<EntitySelector> {
     }
 
     private EntitySelector parse(StringReader reader, boolean allowSelectors) throws CommandSyntaxException {
+        // CraftBukkit start
+        return this.parse(reader, allowSelectors, false);
+    }
+    public EntitySelector parse(StringReader reader, boolean allowSelectors, boolean overridePermissions) throws CommandSyntaxException {
+        // CraftBukkit end
         int i = 0;
         EntitySelectorParser entitySelectorParser = new EntitySelectorParser(reader, allowSelectors);
-        EntitySelector entitySelector = entitySelectorParser.parse();
+        EntitySelector entitySelector = entitySelectorParser.parse(overridePermissions); // CraftBukkit
         if (entitySelector.getMaxResults() > 1 && this.single) {
             if (this.playersOnly) {
                 reader.setCursor(0);
@@ -130,9 +135,15 @@ public class EntityArgument implements ArgumentType<EntitySelector> {
         if (context.getSource() instanceof SharedSuggestionProvider sharedSuggestionProvider) {
             StringReader stringReader = new StringReader(builder.getInput());
             stringReader.setCursor(builder.getStart());
+            // Paper start - Fix EntityArgument permissions
+            final boolean permission = sharedSuggestionProvider instanceof CommandSourceStack stack
+                ? stack.bypassSelectorPermissions || stack.hasPermission(Permissions.COMMANDS_ENTITY_SELECTORS, "minecraft.command.selector")
+                // Only CommandSourceStack implements SharedSuggestionProvider. If *somehow* anything else ends up here, try to query its permission level, otherwise yield false.
+                : sharedSuggestionProvider.permissions().hasPermission(Permissions.COMMANDS_ENTITY_SELECTORS);
             EntitySelectorParser entitySelectorParser = new EntitySelectorParser(
-                stringReader, sharedSuggestionProvider.permissions().hasPermission(Permissions.COMMANDS_ENTITY_SELECTORS)
+                stringReader, permission
             );
+            // Paper end - Fix EntityArgument permissions
 
             try {
                 entitySelectorParser.parse();

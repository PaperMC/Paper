From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/util/datafix/DataFixers.java b/net/minecraft/util/datafix/DataFixers.java
index 261d74ca0be17c382bab7e87f8bb98e1908a2c5f..79685009e9ba6463ad27f45b70bed9b2b922ccda 100644
--- a/net/minecraft/util/datafix/DataFixers.java
+++ b/net/minecraft/util/datafix/DataFixers.java
@@ -534,6 +534,24 @@ public class DataFixers {
         Schema schema44 = builder.addSchema(1456, SAME_NAMESPACED);
         builder.addFixer(new EntityItemFrameDirectionFix(schema44, false));
         Schema schema45 = builder.addSchema(1458, V1458::new);
+        // CraftBukkit start
+        // API allows setting player custom names, so we need to convert them.
+        // This does *not* handle upgrades in any other version, but generally those shouldn't need conversion.
+        builder.addFixer(new DataFix(schema45, false) {
+            @Override
+            protected TypeRewriteRule makeRule() {
+                return this.fixTypeEverywhereTyped("Player CustomName", this.getInputSchema().getType(References.PLAYER), typed -> {
+                    return typed.update(DSL.remainderFinder(), dynamic -> {
+                        final String customName = dynamic.get("CustomName").asString("");
+                        if (customName.isEmpty()) {
+                            return dynamic.remove("CustomName");
+                        }
+                        return dynamic.set("CustomName", LegacyComponentDataFixUtils.createPlainTextComponent(dynamic.getOps(), customName));
+                    });
+                });
+            }
+        });
+        // CraftBukkit end
         builder.addFixer(new EntityCustomNameToComponentFix(schema45));
         builder.addFixer(new ItemCustomNameToComponentFix(schema45));
         builder.addFixer(new BlockEntityCustomNameToComponentFix(schema45));

From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/server/players/StoredUserList.java b/net/minecraft/server/players/StoredUserList.java
index 99bbf2c6f1192e9dfd7fe8411c916ddb3979614e..9ee855c0d1a30b3c83e0e9e93f1a561ac462bc49 100644
--- a/net/minecraft/server/players/StoredUserList.java
+++ b/net/minecraft/server/players/StoredUserList.java
@@ -28,7 +28,7 @@ public abstract class StoredUserList<K, V extends StoredUserEntry<K>> {
     private static final Logger LOGGER = LogUtils.getLogger();
     private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();
     private final File file;
-    private final Map<String, V> map = Maps.newHashMap();
+    private final Map<String, V> map = Maps.newConcurrentMap(); // Paper - Use ConcurrentHashMap in StoredUserList
     protected final NotificationService notificationService;
 
     public StoredUserList(File file, NotificationService notificationService) {
@@ -59,8 +59,11 @@ public abstract class StoredUserList<K, V extends StoredUserEntry<K>> {
     }
 
     public @Nullable V get(K user) {
-        this.removeExpired();
-        return this.map.get(this.getKeyForUser(user));
+        // Paper start - Use ConcurrentHashMap in StoredUserList
+        return this.map.computeIfPresent(this.getKeyForUser(user), (key, value) -> {
+            return value.hasExpired() ? null : value;
+        });
+        // Paper end - Use ConcurrentHashMap in StoredUserList
     }
 
     public boolean remove(K user) {
@@ -105,21 +108,12 @@ public abstract class StoredUserList<K, V extends StoredUserEntry<K>> {
     }
 
     protected boolean contains(K entry) {
+        this.removeExpired(); // CraftBukkit - SPIGOT-7589: Consistently remove expired entries to mirror .get(...)
         return this.map.containsKey(this.getKeyForUser(entry));
     }
 
     private void removeExpired() {
-        List<K> list = Lists.newArrayList();
-
-        for (V storedUserEntry : this.map.values()) {
-            if (storedUserEntry.hasExpired()) {
-                list.add(storedUserEntry.getUser());
-            }
-        }
-
-        for (K object : list) {
-            this.map.remove(this.getKeyForUser(object));
-        }
+        this.map.values().removeIf(StoredUserEntry::hasExpired); // Paper - Use ConcurrentHashMap in StoredUserList
     }
 
     protected abstract StoredUserEntry<K> createEntry(JsonObject entryData);
@@ -129,6 +123,7 @@ public abstract class StoredUserList<K, V extends StoredUserEntry<K>> {
     }
 
     public void save() throws IOException {
+        this.removeExpired(); // Paper - remove expired values before saving
         JsonArray jsonArray = new JsonArray();
         this.map.values().stream().map(storedEntry -> Util.make(new JsonObject(), storedEntry::serialize)).forEach(jsonArray::add);
 
@@ -153,7 +148,14 @@ public abstract class StoredUserList<K, V extends StoredUserEntry<K>> {
                         this.map.put(this.getKeyForUser(storedUserEntry.getUser()), (V)storedUserEntry);
                     }
                 }
+            // Spigot start
+            } catch (com.google.gson.JsonParseException | NullPointerException ex) {
+                File backup = new File(this.file + ".backup");
+                LOGGER.warn("Unable to read file {}, backing it up to {} and creating new copy.", this.file, backup, ex);
+                this.file.renameTo(backup);
+                this.file.delete();
             }
+            // Spigot end
         }
     }
 }

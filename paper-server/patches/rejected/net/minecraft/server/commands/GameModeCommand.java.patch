From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/server/commands/GameModeCommand.java b/net/minecraft/server/commands/GameModeCommand.java
index 4570307282fc114ec638983fbdc7334b5e82e02a..503447fbb54bed493f1d867c75ef3f344fe7b81b 100644
--- a/net/minecraft/server/commands/GameModeCommand.java
+++ b/net/minecraft/server/commands/GameModeCommand.java
@@ -69,9 +69,21 @@ public class GameModeCommand {
     }
 
     private static boolean setGameMode(CommandSourceStack source, ServerPlayer player, GameType gameMode) {
-        if (player.setGameMode(gameMode)) {
+        // Paper start - Expand PlayerGameModeChangeEvent
+        return setGameMode(source, player, gameMode, org.bukkit.event.player.PlayerGameModeChangeEvent.Cause.COMMAND);
+    }
+
+    public static boolean setGameMode(CommandSourceStack source, ServerPlayer player, GameType gameMode, org.bukkit.event.player.PlayerGameModeChangeEvent.Cause cause) {
+        org.bukkit.event.player.PlayerGameModeChangeEvent event = player.setGameMode(gameMode, cause, null);
+        if (event != null && !event.isCancelled()) {
+            // Paper end - Expand PlayerGameModeChangeEvent
             logGamemodeChange(source, player, gameMode);
             return true;
+            // Paper start - Expand PlayerGameModeChangeEvent
+        } else if (event != null && event.cancelMessage() != null) {
+            source.sendSuccess(() -> io.papermc.paper.adventure.PaperAdventure.asVanilla(event.cancelMessage()), true);
+            return false;
+            // Paper end - Expand PlayerGameModeChangeEvent
         } else {
             return false;
         }

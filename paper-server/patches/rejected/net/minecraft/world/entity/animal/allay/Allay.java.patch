From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/animal/allay/Allay.java b/net/minecraft/world/entity/animal/allay/Allay.java
index c19ce3b52bb74a4cb9cb749bf665225c66c13ba4..0591dc9c39f94768c5ebf74cad7bae98921ff66c 100644
--- a/net/minecraft/world/entity/animal/allay/Allay.java
+++ b/net/minecraft/world/entity/animal/allay/Allay.java
@@ -112,6 +112,7 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
     private float dancingAnimationTicks;
     private float spinningAnimationTicks;
     private float spinningAnimationTicks0;
+    public boolean forceDancing = false; // CraftBukkit
 
     public Allay(EntityType<? extends Allay> type, Level level) {
         super(type, level);
@@ -125,6 +126,12 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
         );
     }
 
+    // CraftBukkit start
+    public void setCanDuplicate(boolean canDuplicate) {
+        this.entityData.set(Allay.DATA_CAN_DUPLICATE, canDuplicate);
+    }
+    // CraftBukkit end
+
     @Override
     protected Brain.Provider<Allay> brainProvider() {
         return Brain.provider(MEMORY_TYPES, SENSOR_TYPES);
@@ -232,7 +239,7 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
     public void aiStep() {
         super.aiStep();
         if (!this.level().isClientSide() && this.isAlive() && this.tickCount % 10 == 0) {
-            this.heal(1.0F);
+            this.heal(1.0F, org.bukkit.event.entity.EntityRegainHealthEvent.RegainReason.REGEN); // CraftBukkit
         }
 
         if (this.isDancing() && this.shouldStopDancing() && this.tickCount % 20 == 0) {
@@ -300,7 +307,12 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
         ItemStack itemInHand = player.getItemInHand(hand);
         ItemStack itemInHand1 = this.getItemInHand(InteractionHand.MAIN_HAND);
         if (this.isDancing() && itemInHand.is(ItemTags.DUPLICATES_ALLAYS) && this.canDuplicate()) {
-            this.duplicateAllay();
+            // CraftBukkit start - handle cancel duplication
+            Allay allay = this.duplicateAllay();
+            if (allay == null) {
+                return InteractionResult.SUCCESS;
+            }
+            // CraftBukkit end
             this.level().broadcastEntityEvent(this, EntityEvent.IN_LOVE_HEARTS);
             this.level().playSound(player, this, SoundEvents.AMETHYST_BLOCK_CHIME, SoundSource.NEUTRAL, 2.0F, 1.0F);
             this.removeInteractionItem(player, itemInHand);
@@ -399,6 +411,7 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
     }
 
     private boolean shouldStopDancing() {
+        if (this.forceDancing) {return false;} // CraftBukkit
         return this.jukeboxPos == null
             || !this.jukeboxPos.closerToCenterThan(this.position(), GameEvent.JUKEBOX_PLAY.value().notificationRadius())
             || !this.level().getBlockState(this.jukeboxPos).is(Blocks.JUKEBOX);
@@ -451,7 +464,7 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
         super.readAdditionalSaveData(input);
         this.readInventoryFromTag(input);
         this.vibrationData = input.read("listener", VibrationSystem.Data.CODEC).orElseGet(VibrationSystem.Data::new);
-        this.setDuplicationCooldown(input.getIntOr("DuplicationCooldown", 0));
+        this.setDuplicationCooldown(input.getLongOr("DuplicationCooldown", 0)); // Paper - Load as long
     }
 
     @Override
@@ -470,15 +483,17 @@ public class Allay extends PathfinderMob implements InventoryCarrier, VibrationS
         this.entityData.set(DATA_CAN_DUPLICATE, duplicationCooldown == 0L);
     }
 
-    public void duplicateAllay() {
+    @Nullable public Allay duplicateAllay() { // CraftBukkit - return allay
         Allay allay = EntityType.ALLAY.create(this.level(), EntitySpawnReason.BREEDING);
         if (allay != null) {
             allay.snapTo(this.position());
             allay.setPersistenceRequired();
             allay.resetDuplicationCooldown();
             this.resetDuplicationCooldown();
-            this.level().addFreshEntity(allay);
+            this.level().addFreshEntity(allay, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.DUPLICATION); // CraftBukkit - reason for duplicated allay
         }
+
+        return allay; // CraftBukkit
     }
 
     public void resetDuplicationCooldown() {

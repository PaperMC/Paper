From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/NeutralMob.java b/net/minecraft/world/entity/NeutralMob.java
index e822a4845a47d0cb6ede093e791f394f554099dd..c2201fde32aaf8cc02b71bc90aee40ef98438066 100644
--- a/net/minecraft/world/entity/NeutralMob.java
+++ b/net/minecraft/world/entity/NeutralMob.java
@@ -50,7 +50,11 @@ public interface NeutralMob {
 
         if (level instanceof ServerLevel) {
             this.setPersistentAngerTarget(EntityReference.read(input, "angry_at"));
-            this.setTarget(EntityReference.getLivingEntity(this.getPersistentAngerTarget(), level));
+            // Paper - Prevent entity loading causing async lookups; Moved diff to separate method
+            // If this entity already survived its first tick, e.g. is loaded and ticked in sync, actively
+            // tick the initial persistent anger.
+            // If not, let the first tick on the baseTick call the method later down the line.
+            if (this instanceof Entity entity && !entity.firstTick) this.tickInitialPersistentAnger(level);
         }
     }
 
@@ -61,11 +65,16 @@ public interface NeutralMob {
             this.stopBeingAngry();
         } else {
             if (target != null) {
-                if (persistentAngerTarget == null || !persistentAngerTarget.matches(target)) {
+                // Paper start - Backport fix for MC-305388 from 26.1-snapshot-5
+                boolean newTarget = persistentAngerTarget == null || !persistentAngerTarget.matches(target);
+                if (newTarget) {
                     this.setPersistentAngerTarget(EntityReference.of(target));
                 }
 
-                this.startPersistentAngerTimer();
+                if (newTarget || updateAnger) {
+                    this.startPersistentAngerTimer();
+                }
+                // Paper end - Backport fix for MC-305388 from 26.1-snapshot-5
             }
 
             if (persistentAngerTarget != null && !this.isAngry() && (target == null || !isValidPlayerTarget(target) || !updateAnger)) {
@@ -120,7 +129,7 @@ public interface NeutralMob {
     default void stopBeingAngry() {
         this.setLastHurtByMob(null);
         this.setPersistentAngerTarget(null);
-        this.setTarget(null);
+        this.setTarget(null, org.bukkit.event.entity.EntityTargetEvent.TargetReason.FORGOT_TARGET); // CraftBukkit
         this.setPersistentAngerEndTime(-1L);
     }
 
@@ -130,7 +139,19 @@ public interface NeutralMob {
 
     void setTarget(@Nullable LivingEntity target);
 
+    boolean setTarget(@Nullable LivingEntity target, org.bukkit.event.entity.EntityTargetEvent.@Nullable TargetReason reason); // CraftBukkit
+
     boolean canAttack(LivingEntity entity);
 
     @Nullable LivingEntity getTarget();
+
+    // Paper start - Prevent entity loading causing async lookups
+    // Update last hurt when ticking
+    default void tickInitialPersistentAnger(Level level) {
+        LivingEntity target = EntityReference.getLivingEntity(this.getPersistentAngerTarget(), level);
+        if (target != null) {
+            this.setTarget(target, null);
+        }
+    }
+    // Paper end - Prevent entity loading causing async lookups
 }

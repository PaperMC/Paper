From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/ai/behavior/PoiCompetitorScan.java b/net/minecraft/world/entity/ai/behavior/PoiCompetitorScan.java
index fd4fc07afe5d0f427b1300def065b0e7cd833d1a..9b595322b21b83d38886d515a3b8dd04cde43cea 100644
--- a/net/minecraft/world/entity/ai/behavior/PoiCompetitorScan.java
+++ b/net/minecraft/world/entity/ai/behavior/PoiCompetitorScan.java
@@ -22,13 +22,32 @@ public class PoiCompetitorScan {
                         level.getPoiManager()
                             .getType(globalPos.pos())
                             .ifPresent(
-                                poi -> instance.<List<LivingEntity>>get(nearestLivingEntities)
-                                    .stream()
-                                    .filter(entity -> entity instanceof Villager && entity != villager)
-                                    .map(entity -> (Villager)entity)
-                                    .filter(LivingEntity::isAlive)
-                                    .filter(v -> competesForSameJobsite(globalPos, poi, v))
-                                    .reduce(villager, PoiCompetitorScan::selectWinner)
+                                // Paper start - Improve performance of PoiCompetitorScan by unrolling stream
+                                // The previous logic used Stream#reduce to simulate a form of single-iteration bubble sort
+                                // in which the "winning" villager would maintain MemoryModuleType.JOB_SITE while all others
+                                // would lose said memory module type by passing each "current winner" and incoming next
+                                // villager to #selectWinner.
+                                poi -> {
+                                    final List<LivingEntity> livingEntities = instance.get(nearestLivingEntities);
+
+                                    Villager winner = villager;
+                                    for (final LivingEntity other : livingEntities) {
+                                        if (other == villager) {
+                                            continue;
+                                        }
+                                        if (!(other instanceof final net.minecraft.world.entity.npc.villager.Villager otherVillager)) {
+                                            continue;
+                                        }
+                                        if (!other.isAlive()) {
+                                            continue;
+                                        }
+                                        if (!competesForSameJobsite(globalPos, poi, otherVillager)) {
+                                            continue;
+                                        }
+                                        winner = selectWinner(winner, otherVillager);
+                                    }
+                                }
+                                // Paper end - Improve performance of PoiCompetitorScan by unrolling stream
                             );
                         return true;
                     }

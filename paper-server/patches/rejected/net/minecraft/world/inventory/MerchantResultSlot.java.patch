From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/inventory/MerchantResultSlot.java b/net/minecraft/world/inventory/MerchantResultSlot.java
index 418a025dfa2dd1c94bb75c9c2b56d1066d0b950d..68aa6d6661558b228bf08cb276132a4c87724214 100644
--- a/net/minecraft/world/inventory/MerchantResultSlot.java
+++ b/net/minecraft/world/inventory/MerchantResultSlot.java
@@ -47,13 +47,34 @@ public class MerchantResultSlot extends Slot {
 
     @Override
     public void onTake(Player player, ItemStack stack) {
-        this.checkTakeAchievements(stack);
+        // this.checkTakeAchievements(stack); // Paper - Add PlayerTradeEvent and PlayerPurchaseEvent; move to after event is called and not cancelled
         MerchantOffer activeOffer = this.slots.getActiveOffer();
+        // Paper start - Add PlayerTradeEvent and PlayerPurchaseEvent
+        io.papermc.paper.event.player.PlayerPurchaseEvent event = null;
+        if (activeOffer != null && player instanceof net.minecraft.server.level.ServerPlayer serverPlayer) {
+            if (this.merchant instanceof net.minecraft.world.entity.npc.villager.AbstractVillager abstractVillager) {
+                event = new io.papermc.paper.event.player.PlayerTradeEvent(serverPlayer.getBukkitEntity(), (org.bukkit.entity.AbstractVillager) abstractVillager.getBukkitEntity(), activeOffer.asBukkit(), true, true);
+            } else if (this.merchant instanceof org.bukkit.craftbukkit.inventory.CraftMerchantCustom.MinecraftMerchant minecraftMerchant) {
+                event = new io.papermc.paper.event.player.PlayerPurchaseEvent(serverPlayer.getBukkitEntity(), minecraftMerchant.getCraftMerchant(), activeOffer.asBukkit(), false, true);
+            }
+            if (event != null) {
+                if (!event.callEvent()) {
+                    stack.setCount(0);
+                    player.containerMenu.sendAllDataToRemote();
+                    int level = merchant instanceof net.minecraft.world.entity.npc.villager.Villager villager ? villager.getVillagerData().level() : 1;
+                    serverPlayer.sendMerchantOffers(player.containerMenu.containerId, merchant.getOffers(), level, merchant.getVillagerXp(), merchant.showProgressBar(), merchant.canRestock());
+                    return;
+                }
+                activeOffer = org.bukkit.craftbukkit.inventory.CraftMerchantRecipe.fromBukkit(event.getTrade()).toMinecraft();
+            }
+        }
+        this.checkTakeAchievements(stack);
+        // Paper end - Add PlayerTradeEvent and PlayerPurchaseEvent
         if (activeOffer != null) {
             ItemStack item = this.slots.getItem(0);
             ItemStack item1 = this.slots.getItem(1);
             if (activeOffer.take(item, item1) || activeOffer.take(item1, item)) {
-                this.merchant.notifyTrade(activeOffer);
+                this.merchant.processTrade(activeOffer, event); // Paper - Add PlayerTradeEvent and PlayerPurchaseEvent
                 player.awardStat(Stats.TRADED_WITH_VILLAGER);
                 this.slots.setItem(0, item);
                 this.slots.setItem(1, item1);

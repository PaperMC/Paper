From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/item/component/Consumable.java b/net/minecraft/world/item/component/Consumable.java
index 07b4d5c28c216730e750fc93fea3ea3f81567696..7402a09f7773281654eb7876f4e72a5f2f8f816b 100644
--- a/net/minecraft/world/item/component/Consumable.java
+++ b/net/minecraft/world/item/component/Consumable.java
@@ -84,7 +84,18 @@ public record Consumable(
 
         stack.getAllOfType(ConsumableListener.class).forEach(consumableListener -> consumableListener.onConsume(level, entity, stack, this));
         if (!level.isClientSide()) {
-            this.onConsumeEffects.forEach(consumeEffect -> consumeEffect.apply(level, stack, entity));
+            // CraftBukkit start
+            org.bukkit.event.entity.EntityPotionEffectEvent.Cause cause;
+            if (stack.is(net.minecraft.world.item.Items.MILK_BUCKET)) {
+                cause = org.bukkit.event.entity.EntityPotionEffectEvent.Cause.MILK;
+            } else if (stack.is(net.minecraft.world.item.Items.POTION)) {
+                cause = org.bukkit.event.entity.EntityPotionEffectEvent.Cause.POTION_DRINK;
+            } else {
+                cause = org.bukkit.event.entity.EntityPotionEffectEvent.Cause.FOOD;
+            }
+
+            this.onConsumeEffects.forEach(consumeEffect -> consumeEffect.apply(level, stack, entity, cause));
+            // CraftBukkit end
         }
 
         entity.gameEvent(this.animation == ItemUseAnimation.DRINK ? GameEvent.DRINK : GameEvent.EAT);
@@ -92,6 +103,17 @@ public record Consumable(
         return stack;
     }
 
+    // CraftBukkit start
+    public void cancelUsingItem(ServerPlayer player, ItemStack stack) {
+        final java.util.List<net.minecraft.network.protocol.Packet<? super net.minecraft.network.protocol.game.ClientGamePacketListener>> packets = new it.unimi.dsi.fastutil.objects.ObjectArrayList<>(); // Paper - properly resend entities - collect packets for bundle
+        stack.getAllOfType(ConsumableListener.class).forEach(listener -> {
+            listener.cancelUsingItem(player, stack, packets); // Paper - properly resend entities - collect packets for bundle
+        });
+        player.level().getServer().getPlayerList().sendActiveEffects(player, packets::add); // Paper - properly resend entities - collect packets for bundle
+        player.connection.send(new net.minecraft.network.protocol.game.ClientboundBundlePacket(packets));
+    }
+    // CraftBukkit end
+
     public boolean canConsume(LivingEntity entity, ItemStack stack) {
         FoodProperties foodProperties = stack.get(DataComponents.FOOD);
         return !(foodProperties != null && entity instanceof Player player) || player.canEat(foodProperties.canAlwaysEat());

From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/item/FireworkRocketItem.java b/net/minecraft/world/item/FireworkRocketItem.java
index 3ca612c358000b7635bbcda4bffb7352778eac63..2c597e20c1ff587f2eadef600bedb9e01b999bbf 100644
--- a/net/minecraft/world/item/FireworkRocketItem.java
+++ b/net/minecraft/world/item/FireworkRocketItem.java
@@ -36,7 +36,7 @@ public class FireworkRocketItem extends Item implements ProjectileItem {
                 ItemStack itemInHand = context.getItemInHand();
                 Vec3 clickLocation = context.getClickLocation();
                 Direction clickedFace = context.getClickedFace();
-                Projectile.spawnProjectile(
+                final Projectile.Delayed<FireworkRocketEntity> fireworkRocketEntity = Projectile.spawnProjectileDelayed( // Paper - PlayerLaunchProjectileEvent
                     new FireworkRocketEntity(
                         level,
                         context.getPlayer(),
@@ -46,9 +46,14 @@ public class FireworkRocketItem extends Item implements ProjectileItem {
                         itemInHand
                     ),
                     serverLevel,
-                    itemInHand
+                    itemInHand, f -> f.spawningEntity = context.getPlayer() == null ? null : context.getPlayer().getUUID() // Paper - firework api - assign spawning entity uuid
                 );
-                itemInHand.shrink(1);
+                // Paper start - PlayerLaunchProjectileEvent
+                com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) context.getPlayer().getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemInHand), (org.bukkit.entity.Firework) fireworkRocketEntity.projectile().getBukkitEntity());
+                if (!event.callEvent() || !fireworkRocketEntity.attemptSpawn()) return InteractionResult.PASS;
+                if (event.shouldConsume() && !context.getPlayer().hasInfiniteMaterials()) itemInHand.shrink(1);
+                else context.getPlayer().containerMenu.forceHeldSlot(context.getHand());
+                // Paper end - PlayerLaunchProjectileEvent
             }
 
             return InteractionResult.SUCCESS;
@@ -60,13 +65,24 @@ public class FireworkRocketItem extends Item implements ProjectileItem {
         if (player.isFallFlying()) {
             ItemStack itemInHand = player.getItemInHand(hand);
             if (level instanceof ServerLevel serverLevel) {
-                if (player.dropAllLeashConnections(null)) {
-                    level.playSound(null, player, SoundEvents.LEAD_BREAK, SoundSource.NEUTRAL, 1.0F, 1.0F);
+                // Paper start - PlayerElytraBoostEvent
+                final Projectile.Delayed<FireworkRocketEntity> delayed = Projectile.spawnProjectileDelayed(new FireworkRocketEntity(level, itemInHand, player), serverLevel, itemInHand, f -> f.spawningEntity = player.getUUID()); // Paper - firework api - assign spawning entity uuid
+                com.destroystokyo.paper.event.player.PlayerElytraBoostEvent event = new com.destroystokyo.paper.event.player.PlayerElytraBoostEvent((org.bukkit.entity.Player) player.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemInHand), (org.bukkit.entity.Firework) delayed.projectile().getBukkitEntity(), org.bukkit.craftbukkit.CraftEquipmentSlot.getHand(hand));
+                if (event.callEvent() && delayed.attemptSpawn()) {
+                    player.awardStat(Stats.ITEM_USED.get(this)); // Moved up from below
+                    if (player.dropAllLeashConnections(null)) {
+                        level.playSound(null, player, SoundEvents.LEAD_BREAK, SoundSource.NEUTRAL, 1.0F, 1.0F);
+                    }
+                    if (event.shouldConsume() && !player.hasInfiniteMaterials()) {
+                        itemInHand.shrink(1); // Moved up from below
+                    } else {
+                        player.containerMenu.forceHeldSlot(hand);
+                    }
+                } else {
+                    player.containerMenu.forceHeldSlot(hand);
                 }
-
-                Projectile.spawnProjectile(new FireworkRocketEntity(level, itemInHand, player), serverLevel, itemInHand);
-                itemInHand.consume(1, player);
-                player.awardStat(Stats.ITEM_USED.get(this));
+                // Moved up consume and changed consume to shrink
+                // Paper end - PlayerElytraBoostEvent
             }
 
             return InteractionResult.SUCCESS;

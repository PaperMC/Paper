From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/item/consume_effects/TeleportRandomlyConsumeEffect.java b/net/minecraft/world/item/consume_effects/TeleportRandomlyConsumeEffect.java
index 28a207055f5e9a1c995cfb1610ff941686ef10d7..195f041e94a0d4e813c17e94f0fc7318d1a2ea95 100644
--- a/net/minecraft/world/item/consume_effects/TeleportRandomlyConsumeEffect.java
+++ b/net/minecraft/world/item/consume_effects/TeleportRandomlyConsumeEffect.java
@@ -55,7 +55,13 @@ public record TeleportRandomlyConsumeEffect(float diameter) implements ConsumeEf
             }
 
             Vec3 vec3 = entity.position();
-            if (entity.randomTeleport(d, d1, d2, true)) {
+            // CraftBukkit start - handle canceled status of teleport event
+            java.util.Optional<Boolean> status = entity.randomTeleport(d, d1, d2, true, org.bukkit.event.player.PlayerTeleportEvent.TeleportCause.CONSUMABLE_EFFECT);
+
+            // teleport event was canceled, no more tries
+            if (status.isEmpty()) break;
+            if (status.get()) {
+                // CraftBukkit end
                 level.gameEvent(GameEvent.TELEPORT, vec3, GameEvent.Context.of(entity));
                 SoundSource soundSource;
                 SoundEvent soundEvent;

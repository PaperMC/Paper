From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/PointedDripstoneBlock.java b/net/minecraft/world/level/block/PointedDripstoneBlock.java
index c4332a1bfd8fa6ba74e3b9b8448ed7231b7d5e9c..1510827a9d402d78cf5a6ba0a973bb7b88668aac 100644
--- a/net/minecraft/world/level/block/PointedDripstoneBlock.java
+++ b/net/minecraft/world/level/block/PointedDripstoneBlock.java
@@ -144,6 +144,11 @@ public class PointedDripstoneBlock extends Block implements Fallable, SimpleWate
                 && projectile.mayBreak(serverLevel)
                 && projectile instanceof ThrownTrident
                 && projectile.getDeltaMovement().length() > 0.6) {
+                // CraftBukkit start
+                if (!org.bukkit.craftbukkit.event.CraftEventFactory.callEntityChangeBlockEvent(projectile, blockPos, state.getFluidState().createLegacyBlock())) { // Paper - fix wrong block state
+                    return;
+                }
+                // CraftBukkit end
                 level.destroyBlock(blockPos, true);
             }
         }
@@ -152,7 +157,7 @@ public class PointedDripstoneBlock extends Block implements Fallable, SimpleWate
     @Override
     public void fallOn(Level level, BlockState state, BlockPos pos, Entity entity, double fallDistance) {
         if (state.getValue(TIP_DIRECTION) == Direction.UP && state.getValue(THICKNESS) == DripstoneThickness.TIP) {
-            entity.causeFallDamage(fallDistance + 2.5, 2.0F, level.damageSources().stalagmite());
+            entity.causeFallDamage(fallDistance + 2.5, 2.0F, level.damageSources().stalagmite().eventBlockDamager(level, pos)); // CraftBukkit
         } else {
             super.fallOn(level, state, pos, entity, fallDistance);
         }
@@ -210,10 +215,11 @@ public class PointedDripstoneBlock extends Block implements Fallable, SimpleWate
                         if (blockPos != null) {
                             if (fluidAboveStalactite.get().sourceState.is(Blocks.MUD) && fluid == Fluids.WATER) {
                                 BlockState blockState = Blocks.CLAY.defaultBlockState();
-                                level.setBlockAndUpdate(fluidAboveStalactite.get().pos, blockState);
+                                if (org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(level, fluidAboveStalactite.get().pos, blockState, Block.UPDATE_ALL)) { // Paper - Call BlockFormEvent
                                 Block.pushEntitiesUp(fluidAboveStalactite.get().sourceState, blockState, level, fluidAboveStalactite.get().pos);
                                 level.gameEvent(GameEvent.BLOCK_CHANGE, fluidAboveStalactite.get().pos, GameEvent.Context.of(blockState));
                                 level.levelEvent(LevelEvent.DRIPSTONE_DRIP, blockPos, 0);
+                                } // Paper - Call BlockFormEvent
                             } else {
                                 BlockPos blockPos1 = findFillableCauldronBelowStalactiteTip(level, blockPos, fluid);
                                 if (blockPos1 != null) {
@@ -357,17 +363,17 @@ public class PointedDripstoneBlock extends Block implements Fallable, SimpleWate
         if (isUnmergedTipWithDirection(blockState, direction.getOpposite())) {
             createMergedTips(blockState, server, blockPos);
         } else if (blockState.isAir() || blockState.is(Blocks.WATER)) {
-            createDripstone(server, blockPos, direction, DripstoneThickness.TIP);
+            createDripstone(server, blockPos, direction, DripstoneThickness.TIP, pos); // CraftBukkit
         }
     }
 
-    private static void createDripstone(LevelAccessor level, BlockPos pos, Direction direction, DripstoneThickness thickness) {
+    private static void createDripstone(LevelAccessor level, BlockPos pos, Direction direction, DripstoneThickness thickness, BlockPos source) { // CraftBukkit
         BlockState blockState = Blocks.POINTED_DRIPSTONE
             .defaultBlockState()
             .setValue(TIP_DIRECTION, direction)
             .setValue(THICKNESS, thickness)
             .setValue(WATERLOGGED, level.getFluidState(pos).getType() == Fluids.WATER);
-        level.setBlock(pos, blockState, Block.UPDATE_ALL);
+        org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, pos, blockState, Block.UPDATE_ALL); // CraftBukkit
     }
 
     private static void createMergedTips(BlockState state, LevelAccessor level, BlockPos pos) {
@@ -381,8 +387,8 @@ public class PointedDripstoneBlock extends Block implements Fallable, SimpleWate
             blockPos = pos.below();
         }
 
-        createDripstone(level, blockPos1, Direction.DOWN, DripstoneThickness.TIP_MERGE);
-        createDripstone(level, blockPos, Direction.UP, DripstoneThickness.TIP_MERGE);
+        createDripstone(level, blockPos1, Direction.DOWN, DripstoneThickness.TIP_MERGE, pos); // CraftBukkit
+        createDripstone(level, blockPos, Direction.UP, DripstoneThickness.TIP_MERGE, pos); // CraftBukkit
     }
 
     public static void spawnDripParticle(Level level, BlockPos pos, BlockState state) {

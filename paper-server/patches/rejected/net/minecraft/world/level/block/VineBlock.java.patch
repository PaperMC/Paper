From c8366d72279d30331daff185f7b263159a86ff4d Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/VineBlock.java b/net/minecraft/world/level/block/VineBlock.java
index 80e4c6dd39b32d0d5196f0fcc7bb5fa297f7efa6..b98e720f3996d88f21f448f1fe967e4d8203170d 100644
--- a/net/minecraft/world/level/block/VineBlock.java
+++ b/net/minecraft/world/level/block/VineBlock.java
@@ -166,7 +166,7 @@ public class VineBlock extends Block {
     @Override
     protected void randomTick(BlockState state, ServerLevel level, BlockPos pos, RandomSource random) {
         if (level.getGameRules().get(GameRules.SPREAD_VINES)) {
-            if (random.nextInt(4) == 0) {
+            if (random.nextFloat() < (level.spigotConfig.vineModifier / (100.0F * 4))) { // Spigot - SPIGOT-7159: Better modifier resolution
                 Direction random1 = Direction.getRandom(random);
                 BlockPos blockPos = pos.above();
                 if (random1.getAxis().isHorizontal() && !state.getValue(getPropertyForFace(random1))) {
@@ -180,28 +180,31 @@ public class VineBlock extends Block {
                             boolean value1 = state.getValue(getPropertyForFace(counterClockWise));
                             BlockPos blockPos2 = blockPos1.relative(clockWise);
                             BlockPos blockPos3 = blockPos1.relative(counterClockWise);
+                            // CraftBukkit start - Call BlockSpreadEvent
+                            BlockPos source = pos;
                             if (value && isAcceptableNeighbour(level, blockPos2, clockWise)) {
-                                level.setBlock(blockPos1, this.defaultBlockState().setValue(getPropertyForFace(clockWise), true), Block.UPDATE_CLIENTS);
+                                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, blockPos1, this.defaultBlockState().setValue(getPropertyForFace(clockWise), true), Block.UPDATE_CLIENTS);
                             } else if (value1 && isAcceptableNeighbour(level, blockPos3, counterClockWise)) {
-                                level.setBlock(blockPos1, this.defaultBlockState().setValue(getPropertyForFace(counterClockWise), true), Block.UPDATE_CLIENTS);
+                                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, blockPos1, this.defaultBlockState().setValue(getPropertyForFace(counterClockWise), true), Block.UPDATE_CLIENTS);
                             } else {
                                 Direction opposite = random1.getOpposite();
                                 if (value && level.isEmptyBlock(blockPos2) && isAcceptableNeighbour(level, pos.relative(clockWise), opposite)) {
-                                    level.setBlock(blockPos2, this.defaultBlockState().setValue(getPropertyForFace(opposite), true), Block.UPDATE_CLIENTS);
+                                    org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, blockPos2, this.defaultBlockState().setValue(getPropertyForFace(opposite), true), Block.UPDATE_CLIENTS);
                                 } else if (value1 && level.isEmptyBlock(blockPos3) && isAcceptableNeighbour(level, pos.relative(counterClockWise), opposite)) {
-                                    level.setBlock(blockPos3, this.defaultBlockState().setValue(getPropertyForFace(opposite), true), Block.UPDATE_CLIENTS);
+                                    org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, blockPos3, this.defaultBlockState().setValue(getPropertyForFace(opposite), true), Block.UPDATE_CLIENTS);
                                 } else if (random.nextFloat() < 0.05 && isAcceptableNeighbour(level, blockPos1.above(), Direction.UP)) {
-                                    level.setBlock(blockPos1, this.defaultBlockState().setValue(UP, true), Block.UPDATE_CLIENTS);
+                                    org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, source, blockPos1, this.defaultBlockState().setValue(UP, true), Block.UPDATE_CLIENTS);
                                 }
+                                // CraftBukkit end
                             }
                         } else if (isAcceptableNeighbour(level, blockPos1, random1)) {
-                            level.setBlock(pos, state.setValue(getPropertyForFace(random1), true), Block.UPDATE_CLIENTS);
+                            org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockGrowEvent(level, pos, (BlockState) state.setValue(VineBlock.getPropertyForFace(random1), true), Block.UPDATE_CLIENTS); // CraftBukkit
                         }
                     }
                 } else {
                     if (random1 == Direction.UP && pos.getY() < level.getMaxY()) {
                         if (this.canSupportAtFace(level, pos, random1)) {
-                            level.setBlock(pos, state.setValue(UP, true), Block.UPDATE_CLIENTS);
+                            org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockGrowEvent(level, pos, state.setValue(UP, true), Block.UPDATE_CLIENTS); // CraftBukkit
                             return;
                         }
 
@@ -219,7 +222,7 @@ public class VineBlock extends Block {
                             }
 
                             if (this.hasHorizontalConnection(blockState1)) {
-                                level.setBlock(blockPos, blockState1, Block.UPDATE_CLIENTS);
+                                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, pos, blockPos, blockState1, Block.UPDATE_CLIENTS); // CraftBukkit
                             }
 
                             return;
@@ -233,7 +236,7 @@ public class VineBlock extends Block {
                             BlockState blockState2 = blockState.isAir() ? this.defaultBlockState() : blockState;
                             BlockState blockState3 = this.copyRandomFaces(state, blockState2, random);
                             if (blockState2 != blockState3 && this.hasHorizontalConnection(blockState3)) {
-                                level.setBlock(blockPos1, blockState3, Block.UPDATE_CLIENTS);
+                                org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, pos, blockPos1, blockState3, Block.UPDATE_CLIENTS); // CraftBukkit
                             }
                         }
                     }

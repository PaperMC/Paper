From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jason Penilla <11360596+jpenilla@users.noreply.github.com>
Date: Wed, 4 Feb 2026 19:10:35 -0700
Subject: [PATCH] Endermux console protocl support


diff --git a/net/minecraft/server/MinecraftServer.java b/net/minecraft/server/MinecraftServer.java
index c2227d57ea2e2da537a313d4bfd2f8c7f776be64..0d5a274c10ccff3fbe1fcdbccdcdfe5b20206e9d 100644
--- a/net/minecraft/server/MinecraftServer.java
+++ b/net/minecraft/server/MinecraftServer.java
@@ -306,6 +306,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
     public boolean isIteratingOverLevels = false; // Paper - Throw exception on world create while being ticked
     private final Set<String> pluginsBlockingSleep = new java.util.HashSet<>(); // Paper - API to allow/disallow tick sleeping
     public static final long SERVER_INIT = System.nanoTime(); // Paper - Lag compensation
+    public io.papermc.paper.console.endermux.PaperEndermux endermux;
     // Paper start - improve tick loop
     public final ca.spottedleaf.moonrise.common.time.TickData tickTimes1s  = new ca.spottedleaf.moonrise.common.time.TickData(java.util.concurrent.TimeUnit.SECONDS.toNanos(1L));
     public final ca.spottedleaf.moonrise.common.time.TickData tickTimes5s  = new ca.spottedleaf.moonrise.common.time.TickData(java.util.concurrent.TimeUnit.SECONDS.toNanos(5L));
@@ -1115,6 +1116,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         this.isRestarting = isRestarting;
         this.hasLoggedStop = true; // Paper - Debugging
         if (isDebugging()) io.papermc.paper.util.TraceUtil.dumpTraceForThread("Server stopped"); // Paper - Debugging
+        if (this.endermux != null) this.endermux.disableInteractivity();
         // Paper end
         this.running = false;
         if (waitForShutdown) {
@@ -1992,7 +1994,23 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
 
     @Override
     public void sendSystemMessage(Component message) {
-        LOGGER.info(io.papermc.paper.adventure.PaperAdventure.ANSI_SERIALIZER.serialize(io.papermc.paper.adventure.PaperAdventure.asAdventure(message))); // Paper - Log message with colors
+        final net.kyori.adventure.text.Component adventureMessage = io.papermc.paper.adventure.PaperAdventure.asAdventure(message);
+        final var renderer = new xyz.jpenilla.endermux.server.util.LanguageRenderer(new xyz.jpenilla.endermux.server.util.LanguageRenderer.LanguageProxy() {
+            @Override
+            public boolean has(final String key) {
+                return net.minecraft.locale.Language.getInstance().has(key);
+            }
+
+            @Override
+            public String getOrDefault(final String key, final String fallback) {
+                return net.minecraft.locale.Language.getInstance().getOrDefault(key, fallback);
+            }
+        });
+        final var translated = renderer.render(adventureMessage, net.kyori.adventure.translation.Translator.parseLocale("en_us"));
+        final var serialized = net.kyori.adventure.text.serializer.gson.GsonComponentSerializer.gson().serialize(translated);
+        org.apache.logging.log4j.ThreadContext.put(xyz.jpenilla.endermux.server.log.RemoteLogForwarder.COMPONENT_LOG_MESSAGE_KEY, serialized);
+        LOGGER.info(io.papermc.paper.adventure.PaperAdventure.ANSI_SERIALIZER.serialize(adventureMessage)); // Paper - Log message with colors
+        org.apache.logging.log4j.ThreadContext.remove(xyz.jpenilla.endermux.server.log.RemoteLogForwarder.COMPONENT_LOG_MESSAGE_KEY);
     }
 
     public KeyPair getKeyPair() {
diff --git a/net/minecraft/server/dedicated/DedicatedServer.java b/net/minecraft/server/dedicated/DedicatedServer.java
index eb06d8f012684845146429832e977e6c1ddcd62b..a593483571af475ade1acbd385219c5bcfa28913 100644
--- a/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/net/minecraft/server/dedicated/DedicatedServer.java
@@ -166,6 +166,8 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
 
     @Override
     public boolean initServer() throws IOException {
+        this.endermux = new io.papermc.paper.console.endermux.PaperEndermux(); // TODO config
+        if (this.endermux != null) this.endermux.start(this);
         int i = this.getProperties().managementServerPort;
         if (this.getProperties().managementServerEnabled) {
             String string = this.settings.getProperties().managementServerSecret;
@@ -270,6 +272,7 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
         // Paper end - fix converting txt to json file
         org.spigotmc.WatchdogThread.doStart(org.spigotmc.SpigotConfig.timeoutTime, org.spigotmc.SpigotConfig.restartOnCrash); // Paper - start watchdog thread
         thread.start(); // Paper - Enhance console tab completions for brigadier commands; start console thread after MinecraftServer.console & PaperConfig are initialized
+        if (this.endermux != null) this.endermux.enableInteractivity(this);
         io.papermc.paper.command.PaperCommands.registerCommands(this); // Paper - setup /paper command
         this.server.spark.registerCommandBeforePlugins(this.server); // Paper - spark
         com.destroystokyo.paper.Metrics.PaperMetrics.startMetrics(); // Paper - start metrics
@@ -540,6 +543,8 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             }
         }
 
+        if (this.endermux != null) this.endermux.close();
+
         this.hasFullyShutdown = true; // Paper - Improved watchdog support
         System.exit(this.abnormalExit ? 70 : 0); // CraftBukkit // Paper - Improved watchdog support
     }

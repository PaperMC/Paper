From 6a0255d07a09045c7b0d3db3fa88ccfd06092226 Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/ai/behavior/GoToWantedItem.java b/net/minecraft/world/entity/ai/behavior/GoToWantedItem.java
index 1927b21b9881b9571ac5d6abc93f279a63d583cd..e74351a7fe7c47821f032147693d6ab53a86371f 100644
--- a/net/minecraft/world/entity/ai/behavior/GoToWantedItem.java
+++ b/net/minecraft/world/entity/ai/behavior/GoToWantedItem.java
@@ -35,6 +35,21 @@ public class GoToWantedItem {
                                 && itemEntity.closerThan(entity, maxDistToWalk)
                                 && entity.level().getWorldBorder().isWithinBounds(itemEntity.blockPosition())
                                 && entity.canPickUpLoot()) {
+                                // CraftBukkit start
+                                if (entity instanceof net.minecraft.world.entity.animal.allay.Allay) {
+                                    org.bukkit.event.entity.EntityTargetEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callEntityTargetEvent(entity, itemEntity, org.bukkit.event.entity.EntityTargetEvent.TargetReason.CLOSEST_ENTITY);
+
+                                    if (event.isCancelled()) {
+                                        return false;
+                                    }
+                                    if (!(event.getTarget() instanceof org.bukkit.craftbukkit.entity.CraftItem targetItem)) { // Paper - only erase allay memory on non-item targets
+                                        nearestVisibleWantedItem.erase();
+                                        return false; // Paper - only erase allay memory on non-item targets
+                                    }
+
+                                    itemEntity = targetItem.getHandle();
+                                }
+                                // CraftBukkit end
                                 WalkTarget walkTarget1 = new WalkTarget(new EntityTracker(itemEntity, false), speedModifier, 0);
                                 lookTarget.set(new EntityTracker(itemEntity, true));
                                 walkTarget.set(walkTarget1);

--- a/net/minecraft/world/level/storage/PlayerDataStorage.java
+++ b/net/minecraft/world/level/storage/PlayerDataStorage.java
@@ -31,6 +_,7 @@
     }
 
     public void save(final Player player) {
+        if (org.spigotmc.SpigotConfig.disablePlayerDataSaving) return; // Spigot
         try (ProblemReporter.ScopedCollector reporter = new ProblemReporter.ScopedCollector(player.problemPath(), LOGGER)) {
             TagValueOutput output = TagValueOutput.createWithContext(reporter, player.registryAccess());
             player.saveWithoutId(output);
@@ -42,7 +_,7 @@
             Path oldFile = playerDirPath.resolve(player.getStringUUID() + ".dat_old");
             Util.safeReplaceFile(realFile, tmpFile, oldFile);
         } catch (Exception var11) {
-            LOGGER.warn("Failed to save player data for {}", player.getPlainTextName());
+            LOGGER.warn("Failed to save player data for {}", player.getPlainTextName(), var11); // Paper - Print exception
         }
     }
 
@@ -62,9 +_,25 @@
 
     private Optional<CompoundTag> load(final NameAndId nameAndId, final String suffix) {
         File realFile = new File(this.playerDir, nameAndId.id() + suffix);
+        // Spigot start
+        boolean usingWrongFile = false;
+        if (org.bukkit.Bukkit.getOnlineMode() && !file.exists()) { // Paper - Check online mode first
+            file = new File(this.playerDir, net.minecraft.core.UUIDUtil.createOfflinePlayerUUID(nameAndId.name()) + suffix);
+            if (file.exists()) {
+                usingWrongFile = true;
+                LOGGER.warn("Using offline mode UUID file for player {} as it is the only copy we can find.", nameAndId.name());
+            }
+        }
+        // Spigot end
         if (realFile.exists() && realFile.isFile()) {
             try {
-                return Optional.of(NbtIo.readCompressed(realFile.toPath(), NbtAccounter.unlimitedHeap()));
+                // Spigot start
+                Optional<CompoundTag> optional = Optional.of(NbtIo.readCompressed(realFile.toPath(), NbtAccounter.unlimitedHeap()));
+                if (usingWrongFile) {
+                    file.renameTo(new File(file.getPath() + ".offline-read"));
+                }
+                return optional;
+                // Spigot end
             } catch (Exception var5) {
                 LOGGER.warn("Failed to load player data for {}", nameAndId.name());
             }
@@ -84,4 +_,10 @@
             return DataFixTypes.PLAYER.updateToCurrentVersion(this.fixerUpper, tag, version);
         });
     }
+
+    // CraftBukkit start
+    public File getPlayerDir() {
+        return this.playerDir;
+    }
+    // CraftBukkit end
 }

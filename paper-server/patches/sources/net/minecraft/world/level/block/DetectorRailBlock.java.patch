From 3aeeaf31b7a7f888f54e47826e8ec0ddbe65c4bf Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/DetectorRailBlock.java b/net/minecraft/world/level/block/DetectorRailBlock.java
index a6c2025a56c7b3f529b68d9a39bda43f0aed6858..8f0217f25a2faf23833be10c85c5febc896ae292 100644
--- a/net/minecraft/world/level/block/DetectorRailBlock.java
+++ b/net/minecraft/world/level/block/DetectorRailBlock.java
@@ -54,6 +54,7 @@ public class DetectorRailBlock extends BaseRailBlock {
 
     @Override
     protected void entityInside(BlockState state, Level level, BlockPos pos, Entity entity) {
+        if (!new io.papermc.paper.event.entity.EntityInsideBlockEvent(entity.getBukkitEntity(), org.bukkit.craftbukkit.block.CraftBlock.at(level, pos)).callEvent()) { return; } // Paper - Add EntityInsideBlockEvent
         if (!level.isClientSide) {
             if (!state.getValue(POWERED)) {
                 this.checkPressed(level, pos, state);
@@ -84,6 +85,7 @@ public class DetectorRailBlock extends BaseRailBlock {
 
     private void checkPressed(Level level, BlockPos pos, BlockState state) {
         if (this.canSurvive(state, level, pos)) {
+            if (!state.is(this)) { return; } // Paper - Fix some rails connecting improperly
             boolean poweredValue = state.getValue(POWERED);
             boolean flag = false;
             List<AbstractMinecart> interactingMinecartOfType = this.getInteractingMinecartOfType(level, pos, AbstractMinecart.class, entity -> true);
@@ -91,6 +93,16 @@ public class DetectorRailBlock extends BaseRailBlock {
                 flag = true;
             }
 
+            // CraftBukkit start
+            if (poweredValue != flag) {
+                org.bukkit.block.Block block = level.getWorld().getBlockAt(pos.getX(), pos.getY(), pos.getZ());
+
+                org.bukkit.event.block.BlockRedstoneEvent eventRedstone = new org.bukkit.event.block.BlockRedstoneEvent(block, flag ? 15 : 0, flag ? 15 : 0);
+                level.getCraftServer().getPluginManager().callEvent(eventRedstone);
+
+                flag = eventRedstone.getNewCurrent() > 0;
+            }
+            // CraftBukkit end
             if (flag && !poweredValue) {
                 BlockState blockState = state.setValue(POWERED, Boolean.valueOf(true));
                 level.setBlock(pos, blockState, 3);

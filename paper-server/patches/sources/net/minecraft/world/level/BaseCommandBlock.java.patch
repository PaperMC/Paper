--- a/net/minecraft/world/level/BaseCommandBlock.java
+++ b/net/minecraft/world/level/BaseCommandBlock.java
@@ -30,6 +_,10 @@
     @Nullable Component lastOutput;
     private String command = "";
     private @Nullable Component customName;
+    // CraftBukkit start
+    protected abstract org.bukkit.command.CommandSender getBukkitSender(CommandSourceStack wrapper);
+    public abstract ServerLevel getLevel();
+    // CraftBukkit end
 
     public int getSuccessCount() {
         return this.successCount;
@@ -106,7 +_,13 @@
                                 this.successCount++;
                             }
                         });
-                        level.getServer().getCommands().performPrefixedCommand(commandSourceStack, this.command);
+                        // Paper start - ServerCommandEvent
+                        org.bukkit.event.server.ServerCommandEvent event = new org.bukkit.event.server.ServerCommandEvent(commandSourceStack.getBukkitSender(), net.minecraft.commands.Commands.trimOptionalPrefix(this.command));
+                        if (!event.callEvent()) {
+                            return true;
+                        }
+                        level.getServer().getCommands().performPrefixedCommand(commandSourceStack, event.getCommand());
+                        // Paper end - ServerCommandEvent
                     }
                 } catch (Throwable var7) {
                     CrashReport crashReport = CrashReport.forThrowable(var7, "Executing command block");
@@ -127,8 +_,8 @@
         }
     }
 
-    private BaseCommandBlock.@Nullable CloseableCommandBlockSource createSource(ServerLevel level) {
-        return this.trackOutput ? new BaseCommandBlock.CloseableCommandBlockSource(level) : null;
+    public BaseCommandBlock.CloseableCommandBlockSource createSource(ServerLevel level) { // Paper - public, remove nullable
+        return new BaseCommandBlock.CloseableCommandBlockSource(level, this.trackOutput); // Paper - add back source when output disabled
     }
 
     public Component getName() {
@@ -161,13 +_,21 @@
 
     public abstract boolean isValid();
 
-    protected class CloseableCommandBlockSource implements CommandSource, AutoCloseable {
+    public class CloseableCommandBlockSource implements CommandSource, AutoCloseable { // Paper - public
         private final ServerLevel level;
         private static final DateTimeFormatter TIME_FORMAT = DateTimeFormatter.ofPattern("HH:mm:ss", Locale.ROOT);
         private boolean closed;
 
-        protected CloseableCommandBlockSource(final ServerLevel level) {
+        // Paper start - add back source when output disabled
+        private final boolean trackOutput;
+        public CloseableCommandBlockSource(final ServerLevel level, final boolean trackOutput) {
             this.level = level;
+            this.trackOutput = trackOutput;
+        }
+        @io.papermc.paper.annotation.DoNotUse @Deprecated
+        public CloseableCommandBlockSource(final ServerLevel level) { // Paper - public
+            this(level, true);
+            // Paper end - add back source when output disabled
         }
 
         @Override
@@ -177,7 +_,7 @@
 
         @Override
         public boolean acceptsFailure() {
-            return !this.closed;
+            return this.trackOutput && !this.closed; // Paper - add back source when output disabled
         }
 
         @Override
@@ -187,7 +_,8 @@
 
         @Override
         public void sendSystemMessage(Component message) {
-            if (!this.closed) {
+            if (this.trackOutput && !this.closed) { // Paper - add back source when output disabled
+                org.spigotmc.AsyncCatcher.catchOp("sendSystemMessage to a command block"); // Paper - Don't broadcast messages to command blocks
                 BaseCommandBlock.this.lastOutput = Component.literal("[" + TIME_FORMAT.format(ZonedDateTime.now()) + "] ").append(message);
                 BaseCommandBlock.this.onUpdated(this.level);
             }
@@ -197,5 +_,12 @@
         public void close() throws Exception {
             this.closed = true;
         }
+
+        // CraftBukkit start
+        @Override
+        public org.bukkit.command.CommandSender getBukkitSender(CommandSourceStack wrapper) {
+            return BaseCommandBlock.this.getBukkitSender(wrapper);
+        }
+        // CraftBukkit end
     }
 }

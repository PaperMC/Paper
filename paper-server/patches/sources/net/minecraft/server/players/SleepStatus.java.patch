From 3aeeaf31b7a7f888f54e47826e8ec0ddbe65c4bf Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 14:37:42 +0100
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/server/players/SleepStatus.java b/net/minecraft/server/players/SleepStatus.java
index ad8c79c97872fd8a875554ab3c03c088e239cb84..2a7ae521654ad5c9f392baa5562e64bb71b13097 100644
--- a/net/minecraft/server/players/SleepStatus.java
+++ b/net/minecraft/server/players/SleepStatus.java
@@ -14,8 +14,11 @@ public class SleepStatus {
     }
 
     public boolean areEnoughDeepSleeping(int requiredSleepPercentage, List<ServerPlayer> sleepingPlayers) {
-        int i = (int)sleepingPlayers.stream().filter(Player::isSleepingLongEnough).count();
-        return i >= this.sleepersNeeded(requiredSleepPercentage);
+        // CraftBukkit start
+        int i = (int) sleepingPlayers.stream().filter(player -> player.isSleepingLongEnough() || player.fauxSleeping).count();
+        boolean anyDeepSleep = sleepingPlayers.stream().anyMatch(Player::isSleepingLongEnough);
+        return anyDeepSleep && i >= this.sleepersNeeded(requiredSleepPercentage);
+        // CraftBukkit end
     }
 
     public int sleepersNeeded(int requiredSleepPercentage) {
@@ -35,16 +38,22 @@ public class SleepStatus {
         int i1 = this.sleepingPlayers;
         this.activePlayers = 0;
         this.sleepingPlayers = 0;
+        boolean anySleep = false; // CraftBukkit
 
         for (ServerPlayer serverPlayer : players) {
             if (!serverPlayer.isSpectator()) {
                 this.activePlayers++;
-                if (serverPlayer.isSleeping()) {
+                if (serverPlayer.isSleeping() || serverPlayer.fauxSleeping) { // CraftBukkit
                     this.sleepingPlayers++;
                 }
+                // CraftBukkit start
+                if (serverPlayer.isSleeping()) {
+                    anySleep = true;
+                }
+                // CraftBukkit end
             }
         }
 
-        return (i1 > 0 || this.sleepingPlayers > 0) && (i != this.activePlayers || i1 != this.sleepingPlayers);
+        return anySleep && (i1 > 0 || this.sleepingPlayers > 0) && (i != this.activePlayers || i1 != this.sleepingPlayers); // CraftBukkit
     }
 }

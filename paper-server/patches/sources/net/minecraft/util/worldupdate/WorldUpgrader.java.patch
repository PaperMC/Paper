--- a/net/minecraft/util/worldupdate/WorldUpgrader.java
+++ b/net/minecraft/util/worldupdate/WorldUpgrader.java
@@ -89,7 +_,7 @@
         boolean recreateRegionFiles
     ) {
         this.dimensions = registryAccess.lookupOrThrow(Registries.LEVEL_STEM);
-        this.levels = this.dimensions.registryKeySet().stream().map(Registries::levelStemToLevel).collect(Collectors.toUnmodifiableSet());
+        this.levels = java.util.stream.Stream.of(levelStorage.dimensionType).map(Registries::levelStemToLevel).collect(Collectors.toUnmodifiableSet()); // CraftBukkit
         this.eraseCache = eraseCache;
         this.dataFixer = dataFixer;
         this.levelStorage = levelStorage;
@@ -368,7 +_,7 @@
                 int dataVersion = NbtUtils.getDataVersion(compoundTag);
                 ChunkGenerator chunkGenerator = WorldUpgrader.this.dimensions.getValueOrThrow(Registries.levelToLevelStem(dimension)).generator();
                 CompoundTag compoundTag1 = regionStorage.upgradeChunkTag(
-                    compoundTag, -1, ChunkMap.getChunkDataFixContextTag(dimension, chunkGenerator.getTypeNameForDataFixer())
+                    compoundTag, -1, ChunkMap.getChunkDataFixContextTag(Registries.levelToLevelStem(dimension), chunkGenerator.getTypeNameForDataFixer()), null // CraftBukkit
                 );
                 ChunkPos chunkPos1 = new ChunkPos(compoundTag1.getIntOr("xPos", 0), compoundTag1.getIntOr("zPos", 0));
                 if (!chunkPos1.equals(chunkPos)) {

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MiniDigger <admin@minidigger.me>
Date: Wed, 29 Apr 2020 02:10:32 +0200
Subject: [PATCH] Allow delegation to vanilla chunk gen


diff --git a/src/main/java/net/minecraft/world/level/chunk/ChunkConverter.java b/src/main/java/net/minecraft/world/level/chunk/ChunkConverter.java
index 60ecd3a92af0f1968b10bb8babfb43147ef568d3..9077b70650d70dd294f53a1ef73e86e28ceaece9 100644
--- a/src/main/java/net/minecraft/world/level/chunk/ChunkConverter.java
+++ b/src/main/java/net/minecraft/world/level/chunk/ChunkConverter.java
@@ -36,7 +36,7 @@ import org.apache.logging.log4j.Logger;
 public class ChunkConverter {
 
     private static final Logger LOGGER = LogManager.getLogger();
-    public static final ChunkConverter a = new ChunkConverter();
+    public static final ChunkConverter a = new ChunkConverter(); public static ChunkConverter getEmptyConverter() { return a; } // Paper - obfhelper
     private static final EnumDirection8[] c = EnumDirection8.values();
     private final EnumSet<EnumDirection8> d;
     private final int[][] e;
@@ -322,7 +322,7 @@ public class ChunkConverter {
                         if ((Integer) iblockdata.get(BlockProperties.an) >= j) {
                             generatoraccess.setTypeAndData(blockposition, (IBlockData) iblockdata.set(BlockProperties.an, j), 18);
                             if (i != 7) {
-                                EnumDirection[] aenumdirection = null.f;
+                                EnumDirection[] aenumdirection = f; // Paper - decomp fix
                                 int k = aenumdirection.length;
 
                                 for (int l = 0; l < k; ++l) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index d0c951878600a4227e558bc68d68098c59fb7b2b..f8d040ba6c8b3a1294a8ac8d55cbd09705d4be76 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -2027,6 +2027,32 @@ public final class CraftServer implements Server {
         return new CraftChunkData(world);
     }
 
+    // Paper start
+    @Override
+    public ChunkGenerator.ChunkData createVanillaChunkData(World world, int x, int z) {
+        // get empty object
+        CraftChunkData data = (CraftChunkData) createChunkData(world);
+        // do bunch of vanilla shit
+        net.minecraft.server.level.WorldServer nmsWorld = ((CraftWorld) world).getHandle();
+        net.minecraft.world.level.chunk.ProtoChunk protoChunk = new net.minecraft.world.level.chunk.ProtoChunk(new net.minecraft.world.level.ChunkCoordIntPair(x, z), net.minecraft.world.level.chunk.ChunkConverter.getEmptyConverter(), nmsWorld);
+        List<net.minecraft.world.level.chunk.IChunkAccess> list = new ArrayList<>();
+        list.add(protoChunk);
+        net.minecraft.server.level.RegionLimitedWorldAccess genRegion = new net.minecraft.server.level.RegionLimitedWorldAccess(nmsWorld, list);
+        // call vanilla generator, one feature after another. Order here is important!
+        net.minecraft.world.level.chunk.ChunkGenerator chunkGenerator = nmsWorld.getChunkProvider().chunkGenerator;
+        if (chunkGenerator instanceof org.bukkit.craftbukkit.generator.CustomChunkGenerator) {
+            chunkGenerator = ((org.bukkit.craftbukkit.generator.CustomChunkGenerator) chunkGenerator).delegate;
+        }
+        chunkGenerator.createBiomes(nmsWorld.r().b(IRegistry.ay), protoChunk);
+        chunkGenerator.buildNoise(genRegion, nmsWorld.getStructureManager(), protoChunk);
+        chunkGenerator.buildBase(genRegion, protoChunk);
+        // copy over generated sections
+        data.setRawChunkData(protoChunk.getSections());
+        // hooray!
+        return data;
+    }
+    // Paper end
+
     @Override
     public BossBar createBossBar(String title, BarColor color, BarStyle style, BarFlag... flags) {
         return new CraftBossBar(title, color, style, flags);
diff --git a/src/main/java/org/bukkit/craftbukkit/generator/CraftChunkData.java b/src/main/java/org/bukkit/craftbukkit/generator/CraftChunkData.java
index afca0038bb74ac53f07a25729a3c1542e244c6fd..d02281f954aac8d8b65f5d36ec70f0352e4c7cdd 100644
--- a/src/main/java/org/bukkit/craftbukkit/generator/CraftChunkData.java
+++ b/src/main/java/org/bukkit/craftbukkit/generator/CraftChunkData.java
@@ -19,7 +19,7 @@ import org.bukkit.material.MaterialData;
  */
 public final class CraftChunkData implements ChunkGenerator.ChunkData {
     private final int maxHeight;
-    private final ChunkSection[] sections;
+    private ChunkSection[] sections; // Paper - remove final
     private Set<BlockPosition> tiles;
     private World world; // Paper - Anti-Xray - Add world
 
@@ -168,6 +168,12 @@ public final class CraftChunkData implements ChunkGenerator.ChunkData {
         return sections;
     }
 
+    // Paper start
+    public void setRawChunkData(ChunkSection[] sections) {
+        this.sections = sections;
+    }
+    // Paper end
+
     Set<BlockPosition> getTiles() {
         return tiles;
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/generator/CustomChunkGenerator.java b/src/main/java/org/bukkit/craftbukkit/generator/CustomChunkGenerator.java
index 3e6d78a1fac2690ab7113f236a1442ae7ab6dd42..cbb241b420065e016e5bbc340d42c383d9da6478 100644
--- a/src/main/java/org/bukkit/craftbukkit/generator/CustomChunkGenerator.java
+++ b/src/main/java/org/bukkit/craftbukkit/generator/CustomChunkGenerator.java
@@ -33,7 +33,7 @@ import org.bukkit.generator.ChunkGenerator.ChunkData;
 
 public class CustomChunkGenerator extends InternalChunkGenerator {
 
-    private final net.minecraft.world.level.chunk.ChunkGenerator delegate;
+    public final net.minecraft.world.level.chunk.ChunkGenerator delegate; // Paper - public
     private final ChunkGenerator generator;
     private final WorldServer world;
     private final Random random = new Random();

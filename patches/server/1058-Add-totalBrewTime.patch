From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tamion <70228790+notTamion@users.noreply.github.com>
Date: Sun, 15 Sep 2024 19:17:12 +0200
Subject: [PATCH] Add totalBrewTime

== AT ==
public net.minecraft.world.inventory.BrewingStandMenu brewingStandData

diff --git a/src/main/java/net/minecraft/world/inventory/BrewingStandMenu.java b/src/main/java/net/minecraft/world/inventory/BrewingStandMenu.java
index 68c529cb38d61cd3a0f39bef0f666057fc219c9b..b252bb8ddf71fc440a727b9081ee04b10d1e53b3 100644
--- a/src/main/java/net/minecraft/world/inventory/BrewingStandMenu.java
+++ b/src/main/java/net/minecraft/world/inventory/BrewingStandMenu.java
@@ -41,7 +41,25 @@ public class BrewingStandMenu extends AbstractContainerMenu {
     // CraftBukkit end
 
     public BrewingStandMenu(int syncId, Inventory playerInventory) {
-        this(syncId, playerInventory, new SimpleContainer(5), new SimpleContainerData(2));
+        // Paper start - Add totalBrewTime
+        this(syncId, playerInventory, new SimpleContainer(5), new SimpleContainerData(2) {
+            int totalBrewTime = 400;
+
+            @Override
+            public int get(final int index) {
+                return index == -1 ? totalBrewTime : super.get(index);
+            }
+
+            @Override
+            public void set(final int index, final int value) {
+                if (index == -1) {
+                    totalBrewTime = value;
+                    return;
+                }
+                super.set(index, value);
+            }
+        });
+        // Paper end - Add totalBrewTime
     }
 
     public BrewingStandMenu(int syncId, Inventory playerInventory, Container inventory, ContainerData propertyDelegate) {
@@ -60,7 +78,20 @@ public class BrewingStandMenu extends AbstractContainerMenu {
         // Paper end - custom potion mixes
         this.ingredientSlot = this.addSlot(new BrewingStandMenu.IngredientsSlot(potionbrewer, inventory, 3, 79, 17));
         this.addSlot(new BrewingStandMenu.FuelSlot(inventory, 4, 17, 17));
-        this.addDataSlots(propertyDelegate);
+        // Paper start - Add totalBrewTime
+        this.addDataSlots(new SimpleContainerData(2) {
+            @Override
+            public int get(final int index) {
+                if (index == 0) return 400 * propertyDelegate.get(index) / propertyDelegate.get(-1);
+                return propertyDelegate.get(index);
+            }
+
+            @Override
+            public void set(final int index, final int value) {
+                propertyDelegate.set(index, value);
+            }
+        });
+        // Paper end - Add totalBrewTime
 
         int j;
 
diff --git a/src/main/java/net/minecraft/world/level/block/entity/BrewingStandBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/BrewingStandBlockEntity.java
index bf2c303a314205590a2839e0f729af3a9ff40a86..b85767555e8c8b75f3af007f985136207162a243 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/BrewingStandBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/BrewingStandBlockEntity.java
@@ -49,6 +49,7 @@ public class BrewingStandBlockEntity extends BaseContainerBlockEntity implements
     public static final int NUM_DATA_VALUES = 2;
     private NonNullList<ItemStack> items;
     public int brewTime;
+    public int totalBrewTime = 400; // Paper - Add totalBrewTime
     private boolean[] lastPotionCount;
     private Item ingredient;
     public int fuel;
@@ -93,6 +94,11 @@ public class BrewingStandBlockEntity extends BaseContainerBlockEntity implements
                 int j;
 
                 switch (index) {
+                    // Paper start - Add totalBrewTime
+                    case -1:
+                        j = BrewingStandBlockEntity.this.totalBrewTime;
+                        break;
+                    // Paper end - Add totalBrewTime
                     case 0:
                         j = BrewingStandBlockEntity.this.brewTime;
                         break;
@@ -109,6 +115,11 @@ public class BrewingStandBlockEntity extends BaseContainerBlockEntity implements
             @Override
             public void set(int index, int value) {
                 switch (index) {
+                    // Paper start - Add totalBrewTime
+                    case -1:
+                        BrewingStandBlockEntity.this.totalBrewTime = value;
+                        break;
+                    // Paper end - Add totalBrewTime
                     case 0:
                         BrewingStandBlockEntity.this.brewTime = value;
                         break;
@@ -188,6 +199,7 @@ public class BrewingStandBlockEntity extends BaseContainerBlockEntity implements
             // CraftBukkit start
             BrewingStartEvent event = new BrewingStartEvent(CraftBlock.at(world, pos), CraftItemStack.asCraftMirror(itemstack1), 400);
             world.getCraftServer().getPluginManager().callEvent(event);
+            blockEntity.totalBrewTime = event.getTotalBrewTime(); // Paper - Add totalBrewTime
             blockEntity.brewTime = event.getTotalBrewTime(); // 400 -> event.getTotalBrewTime()
             // CraftBukkit end
             blockEntity.ingredient = itemstack1.getItem();
diff --git a/src/main/java/org/bukkit/craftbukkit/block/CraftBrewingStand.java b/src/main/java/org/bukkit/craftbukkit/block/CraftBrewingStand.java
index e9f55c898de827afe6c9f951cbe1b46eea5f4149..76f808fa7dee001ff596a23017a450c56c9f50fe 100644
--- a/src/main/java/org/bukkit/craftbukkit/block/CraftBrewingStand.java
+++ b/src/main/java/org/bukkit/craftbukkit/block/CraftBrewingStand.java
@@ -39,8 +39,21 @@ public class CraftBrewingStand extends CraftContainer<BrewingStandBlockEntity> i
     @Override
     public void setBrewingTime(int brewTime) {
         this.getSnapshot().brewTime = brewTime;
+        // Paper start - Add totalBrewTime
+        if (brewTime > this.getSnapshot().totalBrewTime) this.getSnapshot().totalBrewTime = brewTime;
     }
 
+    @Override
+    public void setTotalBrewTime(int totalBrewTime) {
+        this.getSnapshot().totalBrewTime = totalBrewTime;
+    }
+
+    @Override
+    public int getTotalBrewTime() {
+        return this.getSnapshot().totalBrewTime;
+    }
+    // Paper end - Add totalBrewTime
+
     @Override
     public int getFuelLevel() {
         return this.getSnapshot().fuel;
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
index 674e3a827f8fb64e5c0beefb3c1874d6e8aee4e5..b77873519b06f23985ffbcd6e20107a947e8d99f 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
@@ -163,7 +163,25 @@ public class CraftContainer extends AbstractContainerMenu {
                 this.delegate = new EnchantmentMenu(windowId, bottom);
                 break;
             case BREWING:
-                this.delegate = new BrewingStandMenu(windowId, bottom, top, new SimpleContainerData(2));
+                // Paper start - Add totalBrewTime
+                this.delegate = new BrewingStandMenu(windowId, bottom, top, new SimpleContainerData(2) {
+                    int totalBrewTime = 400;
+
+                    @Override
+                    public int get(final int index) {
+                        return index == -1 ? totalBrewTime : super.get(index);
+                    }
+
+                    @Override
+                    public void set(final int index, final int value) {
+                        if (index == -1) {
+                            totalBrewTime = value;
+                            return;
+                        }
+                        super.set(index, value);
+                    }
+                });
+                // Paper end - Add totalBrewTime
                 break;
             case HOPPER:
                 this.delegate = new HopperMenu(windowId, bottom, top);
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/view/CraftBrewingStandView.java b/src/main/java/org/bukkit/craftbukkit/inventory/view/CraftBrewingStandView.java
index c92e51227cf2c0046a558b012c078c46582aed44..dad30c29a014ba4edacf2f0f297422fbb92610c5 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/view/CraftBrewingStandView.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/view/CraftBrewingStandView.java
@@ -33,6 +33,19 @@ public class CraftBrewingStandView extends CraftInventoryView<BrewingStandMenu>
     @Override
     public void setBrewingTicks(final int brewingTicks) {
         Preconditions.checkArgument(brewingTicks > 0, "The given brewing ticks must be greater than 0");
-        this.container.setData(BrewingStandBlockEntity.DATA_BREW_TIME, brewingTicks);
+        // Paper start - Add totalBrewTime
+        this.container.brewingStandData.set(BrewingStandBlockEntity.DATA_BREW_TIME, brewingTicks);
+        if (brewingTicks > this.container.brewingStandData.get(-1)) this.container.brewingStandData.set(-1, brewingTicks);
     }
+
+    @Override
+    public void setTotalBrewTime(int totalBrewTime) {
+        this.container.brewingStandData.set(-1, totalBrewTime);
+    }
+
+    @Override
+    public int getTotalBrewTime() {
+        return this.container.brewingStandData.get(-1);
+    }
+    // Paper end - Add totalBrewTime
 }

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Barnaby <22575741+barnabwhy@users.noreply.github.com>
Date: Sat, 29 Jun 2024 12:06:51 +0100
Subject: [PATCH] Reduce work done in CraftMapCanvas.drawImage by limiting size
 of image and using System.arraycopy instead of for loops and use bitwise
 operations to do bounds checks.


diff --git a/src/main/java/org/bukkit/craftbukkit/map/CraftMapCanvas.java b/src/main/java/org/bukkit/craftbukkit/map/CraftMapCanvas.java
index ff59f759669620795ef355c988b664bdcda39f52..59f61beb0f179d543fa6adab0989e676a06ab802 100644
--- a/src/main/java/org/bukkit/craftbukkit/map/CraftMapCanvas.java
+++ b/src/main/java/org/bukkit/craftbukkit/map/CraftMapCanvas.java
@@ -1,8 +1,10 @@
 package org.bukkit.craftbukkit.map;
 
 import com.google.common.base.Preconditions;
 import java.awt.Color;
+import java.awt.Graphics2D;
 import java.awt.Image;
+import java.awt.image.BufferedImage;
 import java.util.Arrays;
 import org.bukkit.map.MapCanvas;
 import org.bukkit.map.MapCursorCollection;
@@ -59,8 +64,10 @@ public class CraftMapCanvas implements MapCanvas {
 
     @Override
     public void setPixel(int x, int y, byte color) {
-        if (x < 0 || y < 0 || x >= 128 || y >= 128)
+        // Paper start - Optimise bounds check using bitwise operations
+        if ((x & -128) != 0 || (y & -128) != 0)
             return;
+        // Paper end
         if (this.buffer[y * 128 + x] != color) {
             this.buffer[y * 128 + x] = color;
             this.mapView.worldMap.setColorsDirty(x, y);
@@ -69,15 +76,19 @@ public class CraftMapCanvas implements MapCanvas {
 
     @Override
     public byte getPixel(int x, int y) {
-        if (x < 0 || y < 0 || x >= 128 || y >= 128)
+        // Paper start - Optimise bounds check using bitwise operations
+        if ((x & -128) != 0 || (y & -128) != 0)
             return 0;
+        // Paper end
         return this.buffer[y * 128 + x];
     }
 
     @Override
     public byte getBasePixel(int x, int y) {
-        if (x < 0 || y < 0 || x >= 128 || y >= 128)
+        // Paper start - Optimise bounds check using bitwise operations
+        if ((x & -128) != 0 || (y & -128) != 0)
             return 0;
+        // Paper end
         return this.base[y * 128 + x];
     }
 
@@ -91,12 +102,41 @@ public class CraftMapCanvas implements MapCanvas {
 
     @Override
     public void drawImage(int x, int y, Image image) {
-        byte[] bytes = MapPalette.imageToBytes(image);
-        for (int x2 = 0; x2 < image.getWidth(null); ++x2) {
-            for (int y2 = 0; y2 < image.getHeight(null); ++y2) {
-                this.setPixel(x + x2, y + y2, bytes[y2 * image.getWidth(null) + x2]);
+        // Paper start - Reduce work done by limiting size of image and using System.arraycopy
+        int width = 128 - x;
+        int height = 128 - y;
+        if (image.getHeight(null) < height)
+            height = image.getHeight(null);
+
+        // Create a subimage if the image is larger than the max allowed size
+        BufferedImage temp;
+        if (image.getWidth(null) >= width && image instanceof BufferedImage bImage) {
+            // If the image is larger than the max allowed size, get a subimage, otherwise use the image as is
+            if (image.getWidth(null) > width || image.getHeight(null) > height) {
+                temp = bImage.getSubimage(0, 0, width, height);
+            } else {
+                temp = bImage;
             }
+        } else {
+            temp = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
+            Graphics2D graphics = temp.createGraphics();
+            graphics.drawImage(image, 0, 0, null);
+            graphics.dispose();
+        }
+
+        byte[] bytes = MapPalette.imageToBytes(temp);
+        
+        // Since we now control the size of the image, we can safely use System.arraycopy
+        // If x is 0, we can just copy the entire image as width is 128 and height is <=(128-y)
+        if (x == 0) {
+            System.arraycopy(bytes, 0, this.buffer, y * 128, width * height);
+            return;
+        }
+
+        for (int y2 = 0; y2 < height; ++y2) {
+            System.arraycopy(bytes, 0, this.buffer, (y + y2) * 128 + x, width);
         }
+        // Paper end
     }
 
     @Override

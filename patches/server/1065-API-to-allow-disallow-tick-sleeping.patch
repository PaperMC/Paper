From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Abel <abelvanhulst@gmail.com>
Date: Tue, 12 Nov 2024 22:25:20 +0100
Subject: [PATCH] API to allow/disallow tick sleeping


diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 64b56abf8900d0424100da460fc68ac964394793..e7f94f28efa2df5f4d85ac293bd56f411e8fc623 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -307,6 +307,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
     private static final AtomicReference<RuntimeException> fatalException = new AtomicReference();
     private final SuppressedExceptionCollector suppressedExceptions;
     private final DiscontinuousFrame tickFrame;
+    private boolean allowPausing = true; // Paper - API to allow/disallow tick sleeping
 
     // CraftBukkit start
     public final WorldLoader.DataLoadContext worldLoader;
@@ -1632,7 +1633,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
 
             if (this.emptyTicks >= j) {
                 this.server.spark.tickStart(); // Paper - spark
-                if (this.emptyTicks == j) {
+                if (this.emptyTicks == j && allowPausing) { // Paper - API to allow/disallow tick sleeping
                     MinecraftServer.LOGGER.info("Server empty for {} seconds, pausing", this.pauseWhileEmptySeconds());
                     this.autoSave();
                 }
@@ -3186,4 +3187,11 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         }
     }
     // Paper end - Add tick times API and /mspt command
+
+    // Paper start - API to allow/disallow tick sleeping
+    public void allowPausing(boolean value) {
+        allowPausing = value;
+    }
+    // Paper end - API to allow/disallow tick sleeping
+
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index dfddcfb1fe1679adaecf75375757dca720e76ce1..141a0b5d4866457da1cea08c7635a3b0c38fc228 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -25,6 +25,7 @@ import java.net.InetAddress;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Date;
+import java.util.HashMap;
 import java.util.HashSet;
 import java.util.Iterator;
 import java.util.LinkedHashMap;
@@ -313,6 +314,7 @@ public final class CraftServer implements Server {
     private final io.papermc.paper.logging.SysoutCatcher sysoutCatcher = new io.papermc.paper.logging.SysoutCatcher(); // Paper
     private final io.papermc.paper.potion.PaperPotionBrewer potionBrewer; // Paper - Custom Potion Mixes
     public final io.papermc.paper.SparksFly spark; // Paper - spark
+    public Map<org.bukkit.plugin.java.JavaPlugin, Boolean> pluginsAllowingSleeping = new HashMap<>(); // Paper - API to allow/disallow tick sleeping
 
     // Paper start - Folia region threading API
     private final io.papermc.paper.threadedregions.scheduler.FallbackRegionScheduler regionizedScheduler = new io.papermc.paper.threadedregions.scheduler.FallbackRegionScheduler();
@@ -3246,4 +3248,13 @@ public final class CraftServer implements Server {
         return this.potionBrewer;
     }
     // Paper end
+
+    // Paper start - API to allow/disallow tick sleeping
+    @Override
+    public void allowPausing(final org.bukkit.plugin.java.JavaPlugin plugin, final boolean value) {
+        pluginsAllowingSleeping.put(plugin, value);
+        console.allowPausing(!pluginsAllowingSleeping.containsValue(false));
+    }
+    // Paper end - API to allow/disallow tick sleeping
+
 }

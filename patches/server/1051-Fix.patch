From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tamion <70228790+notTamion@users.noreply.github.com>
Date: Tue, 28 May 2024 11:15:19 +0200
Subject: [PATCH] Fix


diff --git a/src/main/java/net/minecraft/world/entity/projectile/AbstractArrow.java b/src/main/java/net/minecraft/world/entity/projectile/AbstractArrow.java
index 31b8a8bf78d52b5f11b68e780ec09bf78e7bda84..c9d7d3ab2863383ddbf01b6f784c566fca821e44 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/AbstractArrow.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/AbstractArrow.java
@@ -226,36 +226,46 @@ public abstract class AbstractArrow extends Projectile {
             }
 
             while (!this.isRemoved()) {
-                EntityHitResult movingobjectpositionentity = this.findHitEntity(vec3d2, vec3d1);
+                boolean shouldBreak = false;
+                EntityHitResult[] hitResults = ProjectileUtil.getEntityHitResults(this.level(), this, vec3d2, vec3d1, this.getBoundingBox().expandTowards(this.getDeltaMovement()).inflate(1.0D), this::canHitEntity, 0.3f);
+                if (hitResults.length == 0)
+                    hitResults = new EntityHitResult[]{null};
+                for (EntityHitResult movingobjectpositionentity : hitResults) {
+                    if (movingobjectpositionentity != null) {
+                        object = movingobjectpositionentity;
+                    }
 
-                if (movingobjectpositionentity != null) {
-                    object = movingobjectpositionentity;
-                }
+                    if (object != null && ((HitResult) object).getType() == HitResult.Type.ENTITY) {
+                        Entity entity = ((EntityHitResult) object).getEntity();
+                        Entity entity1 = this.getOwner();
 
-                if (object != null && ((HitResult) object).getType() == HitResult.Type.ENTITY) {
-                    Entity entity = ((EntityHitResult) object).getEntity();
-                    Entity entity1 = this.getOwner();
+                        if (entity instanceof Player && entity1 instanceof Player && !((Player) entity1).canHarmPlayer((Player) entity)) {
+                            object = null;
+                            movingobjectpositionentity = null;
+                        }
+                    }
 
-                    if (entity instanceof Player && entity1 instanceof Player && !((Player) entity1).canHarmPlayer((Player) entity)) {
-                        object = null;
-                        movingobjectpositionentity = null;
+                    org.bukkit.event.entity.ProjectileHitEvent event = null;
+                    if (object != null && !flag) {
+                        com.mojang.datafixers.util.Pair<ProjectileDeflection, org.bukkit.event.entity.ProjectileHitEvent> projectiledeflection = this.preHitTargetOrDeflectSelf((HitResult) object); // CraftBukkit - projectile hit event
+
+                        event = projectiledeflection.getSecond();
+                        this.hasImpulse = true;
+                        if (projectiledeflection.getFirst() != ProjectileDeflection.NONE) {
+                            shouldBreak = true;
+                        }
                     }
-                }
 
-                if (object != null && !flag) {
-                    ProjectileDeflection projectiledeflection = this.preHitTargetOrDeflectSelf((HitResult) object); // CraftBukkit - projectile hit event
+                    if (movingobjectpositionentity == null || this.getPierceLevel() <= 0) {
+                        shouldBreak = true;
+                    }
 
-                    this.hasImpulse = true;
-                    if (projectiledeflection != ProjectileDeflection.NONE) {
+                    object = null;
+                    if (event != null & !event.isCancelled())
                         break;
-                    }
                 }
-
-                if (movingobjectpositionentity == null || this.getPierceLevel() <= 0) {
+                if (shouldBreak)
                     break;
-                }
-
-                object = null;
             }
 
             vec3d = this.getDeltaMovement();
@@ -307,7 +317,7 @@ public abstract class AbstractArrow extends Projectile {
 
     // Paper start - Fix cancelling ProjectileHitEvent for piercing arrows
     @Override
-    public ProjectileDeflection preHitTargetOrDeflectSelf(HitResult hitResult) {
+    public com.mojang.datafixers.util.Pair<ProjectileDeflection, org.bukkit.event.entity.ProjectileHitEvent> preHitTargetOrDeflectSelf(HitResult hitResult) {
         if (hitResult instanceof EntityHitResult entityHitResult && this.hitCancelled && this.getPierceLevel() > 0) {
             if (this.piercingIgnoreEntityIds == null) {
                 this.piercingIgnoreEntityIds = new IntOpenHashSet(5);
diff --git a/src/main/java/net/minecraft/world/entity/projectile/AbstractHurtingProjectile.java b/src/main/java/net/minecraft/world/entity/projectile/AbstractHurtingProjectile.java
index a81d6a52674ddf7f818a7665cccd21dd8ea86cbe..4f48bdaf519d2186214f3b38840050b5ef3b1937 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/AbstractHurtingProjectile.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/AbstractHurtingProjectile.java
@@ -85,16 +85,18 @@ public abstract class AbstractHurtingProjectile extends Projectile {
                 this.igniteForSeconds(1);
             }
 
-            HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity, this.getClipType());
-
-            if (movingobjectposition.getType() != HitResult.Type.MISS) {
-                this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
-
-                // CraftBukkit start - Fire ProjectileHitEvent
-                if (this.isRemoved()) {
-                    // CraftEventFactory.callProjectileHitEvent(this, movingobjectposition); // Paper - this is an undesired duplicate event
+            for (HitResult movingobjectposition : ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity, this.getClipType())) {
+                if (movingobjectposition.getType() != HitResult.Type.MISS) {
+                    org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+                    if (event != null && !event.isCancelled()) // CraftBukkit - projectile hit event
+                        break;
+
+                    // CraftBukkit start - Fire ProjectileHitEvent
+                    if (this.isRemoved()) {
+                        // CraftEventFactory.callProjectileHitEvent(this, movingobjectposition); // Paper - this is an undesired duplicate event
+                    }
+                    // CraftBukkit end
                 }
-                // CraftBukkit end
             }
 
             this.checkInsideBlocks();
diff --git a/src/main/java/net/minecraft/world/entity/projectile/FireworkRocketEntity.java b/src/main/java/net/minecraft/world/entity/projectile/FireworkRocketEntity.java
index 6671796d292fbc922a94271136f5a7a4bbdedaca..06621fa01c6199d3a3dc88f8742dba77501bd906 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/FireworkRocketEntity.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/FireworkRocketEntity.java
@@ -163,13 +163,16 @@ public class FireworkRocketEntity extends Projectile implements ItemSupplier {
             this.setDeltaMovement(vec3d);
         }
 
-        HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity);
-
-        if (!this.noPhysics) {
-            this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
-            this.hasImpulse = true;
+        for (HitResult movingobjectposition : ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity)) {
+            if (!this.noPhysics) {
+                org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+                this.hasImpulse = true;
+                if (event != null && !event.isCancelled())
+                    break;
+            }
         }
 
+
         this.updateRotation();
         if (this.life == 0 && !this.isSilent()) {
             this.level().playSound((Player) null, this.getX(), this.getY(), this.getZ(), SoundEvents.FIREWORK_ROCKET_LAUNCH, SoundSource.AMBIENT, 3.0F, 1.0F);
diff --git a/src/main/java/net/minecraft/world/entity/projectile/FishingHook.java b/src/main/java/net/minecraft/world/entity/projectile/FishingHook.java
index 882de08963c72614a3d26cd917916e42b7136042..3e46db3b813cbb99f7db6236ebba5a10ffd76644 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/FishingHook.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/FishingHook.java
@@ -281,9 +281,11 @@ public class FishingHook extends Projectile {
     }
 
     private void checkCollision() {
-        HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity);
-
-        this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
+        for (HitResult movingobjectposition : ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity)) {
+            org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+            if (event != null && !event.isCancelled()) // CraftBukkit - projectile hit event
+                break;
+        }
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/world/entity/projectile/LlamaSpit.java b/src/main/java/net/minecraft/world/entity/projectile/LlamaSpit.java
index ffd01d24cbfc90e2a8807757e61b2cf20a944354..73a0ae9739506de2d6ea71c67d58b84fae072771 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/LlamaSpit.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/LlamaSpit.java
@@ -39,9 +39,12 @@ public class LlamaSpit extends Projectile {
     public void tick() {
         super.tick();
         Vec3 vec3d = this.getDeltaMovement();
-        HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity);
+        for (HitResult movingobjectposition : ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity)) {
+            org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+            if (event != null && !event.isCancelled()) // CraftBukkit - projectile hit event
+                break;
+        }
 
-        this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
         double d0 = this.getX() + vec3d.x;
         double d1 = this.getY() + vec3d.y;
         double d2 = this.getZ() + vec3d.z;
diff --git a/src/main/java/net/minecraft/world/entity/projectile/Projectile.java b/src/main/java/net/minecraft/world/entity/projectile/Projectile.java
index 74c596264d4da551437bd2a23e1c70022cfc73fc..73247671f2ff99d3d038ad9ef2f88d2a06040b66 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/Projectile.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/Projectile.java
@@ -198,13 +198,13 @@ public abstract class Projectile extends Entity implements TraceableEntity {
     }
 
     // CraftBukkit start - call projectile hit event
-    public ProjectileDeflection preHitTargetOrDeflectSelf(HitResult movingobjectposition) { // Paper - protected -> public
+    public com.mojang.datafixers.util.Pair<ProjectileDeflection, org.bukkit.event.entity.ProjectileHitEvent> preHitTargetOrDeflectSelf(HitResult movingobjectposition) { // Paper - protected -> public
         org.bukkit.event.entity.ProjectileHitEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callProjectileHitEvent(this, movingobjectposition);
         this.hitCancelled = event != null && event.isCancelled();
         if (movingobjectposition.getType() == HitResult.Type.BLOCK || !this.hitCancelled) {
-            return this.hitTargetOrDeflectSelf(movingobjectposition);
+            return new com.mojang.datafixers.util.Pair<>(this.hitTargetOrDeflectSelf(movingobjectposition), event);
         }
-        return ProjectileDeflection.NONE;
+        return new com.mojang.datafixers.util.Pair<>(ProjectileDeflection.NONE, event);
     }
     // CraftBukkit end
 
diff --git a/src/main/java/net/minecraft/world/entity/projectile/ProjectileUtil.java b/src/main/java/net/minecraft/world/entity/projectile/ProjectileUtil.java
index 877365a953a0debd14ca8d33073754452ea2f026..3b2ded1089515f3684233c45913b5c0fd907cfdc 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/ProjectileUtil.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/ProjectileUtil.java
@@ -159,4 +159,59 @@ public final class ProjectileUtil {
         abstractArrow.setEnchantmentEffectsFromEntity(entity, damageModifier);
         return abstractArrow;
     }
+
+    @org.jetbrains.annotations.NotNull
+    public static EntityHitResult[] getEntityHitResults(Level world, Entity entity, Vec3 min, Vec3 max, AABB box, Predicate<Entity> predicate, float margin) {
+        java.util.TreeMap<Double, Entity> entities = new java.util.TreeMap<>();
+
+        for (Entity entity3 : world.getEntities(entity, box, predicate)) {
+            AABB aABB = entity3.getBoundingBox().inflate((double)margin);
+            Optional<Vec3> optional = aABB.clip(min, max);
+            if (optional.isPresent()) {
+                double e = min.distanceToSqr(optional.get());
+                entities.put(e, entity3);
+            }
+        }
+
+        EntityHitResult[] results = new EntityHitResult[entities.size()];
+
+        int x = 0;
+        for (final net.minecraft.world.entity.Entity value : entities.values()) {
+            results[x] = new EntityHitResult(value);
+            x++;
+        }
+
+        return results;
+    }
+
+    public static HitResult[] getHitResultsOnMoveVector(Entity entity, Predicate<Entity> predicate) {
+        Vec3 vec3 = entity.getDeltaMovement();
+        Level level = entity.level();
+        Vec3 vec32 = entity.position();
+        return getHitResults(vec32, entity, predicate, vec3, level, 0.3F, ClipContext.Block.COLLIDER);
+    }
+
+    public static HitResult[] getHitResultsOnMoveVector(Entity entity, Predicate<Entity> predicate, ClipContext.Block raycastShapeType) {
+        Vec3 vec3 = entity.getDeltaMovement();
+        Level level = entity.level();
+        Vec3 vec32 = entity.position();
+        return getHitResults(vec32, entity, predicate, vec3, level, 0.3F, raycastShapeType);
+    }
+
+    private static HitResult[] getHitResults(
+        Vec3 pos, Entity entity, Predicate<Entity> predicate, Vec3 velocity, Level world, float margin, ClipContext.Block raycastShapeType
+    ) {
+        Vec3 vec3 = pos.add(velocity);
+        HitResult hitResult = world.clip(new ClipContext(pos, vec3, raycastShapeType, ClipContext.Fluid.NONE, entity));
+        if (hitResult.getType() != HitResult.Type.MISS) {
+            vec3 = hitResult.getLocation();
+        }
+
+        HitResult[] hitResult2 = getEntityHitResults(world, entity, pos, vec3, entity.getBoundingBox().expandTowards(velocity).inflate(1.0), predicate, margin);
+        if (hitResult2.length != 0) {
+            return hitResult2;
+        }
+
+        return new HitResult[]{hitResult};
+    }
 }
diff --git a/src/main/java/net/minecraft/world/entity/projectile/ShulkerBullet.java b/src/main/java/net/minecraft/world/entity/projectile/ShulkerBullet.java
index 8242d0f292120be6cf3d6dcec2820a35809d83dd..7237847222fc3a0905b5f37c8e41e2fec7972f66 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/ShulkerBullet.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/ShulkerBullet.java
@@ -242,10 +242,12 @@ public class ShulkerBullet extends Projectile {
                 this.applyGravity();
             }
 
-            HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity);
-
-            if (movingobjectposition.getType() != HitResult.Type.MISS) {
-                this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
+            for (HitResult movingobjectposition : ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity)) {
+                if (movingobjectposition.getType() != HitResult.Type.MISS) {
+                    org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+                    if (event != null && !event.isCancelled()) // CraftBukkit - projectile hit event
+                        break;
+                }
             }
         }
 
diff --git a/src/main/java/net/minecraft/world/entity/projectile/ThrowableProjectile.java b/src/main/java/net/minecraft/world/entity/projectile/ThrowableProjectile.java
index 5b32364f1452e1b395b91921d045060fd94881b8..d4edb5f847d4bf6e6aa9ac36654782a1c510b5f2 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/ThrowableProjectile.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/ThrowableProjectile.java
@@ -44,9 +44,10 @@ public abstract class ThrowableProjectile extends Projectile {
     @Override
     public void tick() {
         super.tick();
-        HitResult movingobjectposition = ProjectileUtil.getHitResultOnMoveVector(this, this::canHitEntity);
+        HitResult[] movingobjectpositions = ProjectileUtil.getHitResultsOnMoveVector(this, this::canHitEntity);
         boolean flag = false;
 
+        HitResult movingobjectposition = movingobjectpositions[0];
         if (movingobjectposition.getType() == HitResult.Type.BLOCK) {
             BlockPos blockposition = ((BlockHitResult) movingobjectposition).getBlockPos();
             BlockState iblockdata = this.level().getBlockState(blockposition);
@@ -65,8 +66,12 @@ public abstract class ThrowableProjectile extends Projectile {
             }
         }
 
-        if (movingobjectposition.getType() != HitResult.Type.MISS && !flag) {
-            this.preHitTargetOrDeflectSelf(movingobjectposition); // CraftBukkit - projectile hit event
+        for (HitResult hitResult : movingobjectpositions) {
+            if (movingobjectposition.getType() != HitResult.Type.MISS && !flag) {
+                org.bukkit.event.entity.ProjectileHitEvent event = this.preHitTargetOrDeflectSelf(movingobjectposition).getSecond();
+                if (event != null && !event.isCancelled()) // CraftBukkit - projectile hit event
+                    break;
+            }
         }
 
         this.checkInsideBlocks();

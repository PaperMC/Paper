From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tamion <70228790+notTamion@users.noreply.github.com>
Date: Sat, 2 Nov 2024 10:34:58 +0100
Subject: [PATCH] Fix incorrect CommandSourceStack creation for players


diff --git a/src/main/java/org/bukkit/craftbukkit/command/VanillaCommandWrapper.java b/src/main/java/org/bukkit/craftbukkit/command/VanillaCommandWrapper.java
index 945878e989f136ac516eb1c539c0626547c465fb..c74f27ac4b518cee4afd27fd4592407682fdf71e 100644
--- a/src/main/java/org/bukkit/craftbukkit/command/VanillaCommandWrapper.java
+++ b/src/main/java/org/bukkit/craftbukkit/command/VanillaCommandWrapper.java
@@ -78,6 +78,11 @@ public class VanillaCommandWrapper extends BukkitCommand { // Paper
             if (sender instanceof CommandMinecart) {
                 return ((MinecartCommandBlock) ((CraftMinecartCommand) sender).getHandle()).getCommandBlock().createCommandSourceStack();
             }
+            // Paper start - Fix incorrect CommandSourceStack creation for players
+            if (sender instanceof org.bukkit.craftbukkit.entity.CraftPlayer craftPlayer) {
+                return craftPlayer.getHandle().createCommandSourceStack();
+            }
+            // Paper end - Fix incorrect CommandSourceStack creation for players
 
             return entity.getHandle().createCommandSourceStackForNameResolution((ServerLevel) entity.getHandle().level());
         }
